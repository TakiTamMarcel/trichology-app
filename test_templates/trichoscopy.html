<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trychoskopia - {{ patient.name }} {{ patient.surname }}</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Main CSS for sidebar -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/photo-editor.css') }}">
    
    <!-- Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    
    <style>
        /* Reset i podstawowe style */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        /* Kontener główny */
        .trichoscopy-container {
            margin-left: 260px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Nagłówek */
        .trichoscopy-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .patient-info h1 {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .patient-info p {
            font-size: 14px;
            color: #64748b;
            margin: 2px 0 0 0;
        }
        
        /* Przełącznik trybu */
        .mode-switcher {
            display: flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }
        
        .mode-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #64748b;
        }
        
        .mode-btn.active {
            background: white;
            color: #2c3e50;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        

        
        /* Główny obszar */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }
        
        /* TRYB PREZENTACJI */
        .presentation-mode {
            display: none;
            flex: 1;
            position: relative;
        }
        
        .presentation-mode.active {
            display: flex;
        }
        
        .presentation-layout {
            display: flex;
            width: 100%;
            height: calc(100vh - 70px);
            gap: 20px;
            padding: 20px;
        }
        
        .camera-main {
            flex: 2;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            min-height: 400px;
        }
        
        .camera-main video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        .model-sidebar {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            max-width: 400px;
        }
        
        .model-sidebar h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        #model-viewer-presentation {
            flex: 1;
            min-height: 300px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .camera-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .control-btn {
            background: rgba(0,0,0,0.7);
            border: none;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .control-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        .fullscreen-btn {
            background: #4CAF50;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        /* TRYB DOKUMENTACJI */
        .documentation-mode {
            display: none;
            flex: 1;
            padding: 20px;
            gap: 20px;
        }
        
        .documentation-mode.active {
            display: grid;
            grid-template-columns: 500px 1fr 350px;
            gap: 20px;
            min-height: calc(100vh - 140px);
            overflow: visible;
            height: auto;
        }
        
        .doc-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 600px;
            overflow-y: visible;
        }
        
        .doc-panel h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #model-viewer-doc {
            height: 500px;
            min-height: 400px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            background: #f0f0f0;
            border: 1px solid #e1e8ed;
            position: relative;
            flex-shrink: 0;
        }
        
        .model-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
        }
        
        .model-loading i {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .model-loading p {
            margin: 0;
            font-size: 14px;
        }
        
        .model-instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .model-instructions h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .instruction-list {
            list-style: none;
            padding: 0;
        }
        
        .instruction-list li {
            padding: 5px 0;
            color: #64748b;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .instruction-list i {
            color: #4CAF50;
            width: 16px;
                }
        
        .selected-region {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .selected-region h4 {
            margin-bottom: 8px;
            color: #1976d2;
            font-size: 14px;
        }
        
        .region-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Panel kamery i dokumentacji */
        .camera-doc-panel {
            display: flex;
            flex-direction: column;
        }
        
        .camera-preview {
            height: 400px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .photo-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
        }
        
        .photo-btn.primary {
            background: #4CAF50;
            color: white;
        }
        
        .photo-btn.secondary {
            background: #f1f5f9;
            color: #2c3e50;
        }
        
        .photo-btn:hover {
            transform: translateY(-1px);
        }
        
        .note-section {
            flex: 1;
        }
        
        .note-section label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }
        
        .note-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }
        
        .note-section textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        /* Historia zdjęć */
        .photos-history {
            margin-top: 20px;
        }
        
        .photos-history h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .photo-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .photo-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .photo-info {
            flex: 1;
        }
        
        .photo-info h5 {
            margin-bottom: 4px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .photo-info p {
            color: #64748b;
            font-size: 12px;
            margin: 0;
        }
        
        /* Historia markerów */
        .markers-history {
            margin-top: 20px;
        }
        
        .markers-history h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .markers-container {
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            background: #f9f9f9;
        }
        
        .marker-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .marker-item:hover {
            background: #f0f8ff;
            border-color: #4CAF50;
        }
        
        .marker-item::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
        }
        
        .marker-info {
            margin-left: 20px;
        }
        
        .marker-region {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .marker-timestamp {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 4px;
        }
        
        .marker-notes {
            font-size: 0.9em;
            color: #888;
            font-style: italic;
        }
        
        .no-markers {
            text-align: center;
            color: #999;
            font-style: italic;
            margin: 20px 0;
        }
        
        /* Filtry zdjęć */
        .photo-filters {
            margin-bottom: 15px;
        }
        
        .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            color: #333;
        }
        
        /* Legenda kolorów */
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Galeria zdjęć */
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .gallery-header h3 {
            margin: 0;
        }
        
        .btn-fullscreen-gallery {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-fullscreen-gallery:hover {
            background: #45a049;
            transform: translateY(-1px);
        }
        
        .gallery-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .view-toggle {
            display: flex;
            gap: 5px;
        }
        
        .view-btn {
            padding: 8px 12px;
            border: 1px solid #e1e8ed;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }
        
        .view-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        
        .sort-select, .filter-select {
            padding: 8px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            background: white;
            font-size: 12px;
        }
        
        .filter-controls {
            display: flex;
            align-items: center;
        }
        
        .photo-gallery {
            max-height: 600px;
            min-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            background: #fafafa;
            scroll-behavior: smooth;
        }
        
        .photo-gallery.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .photo-gallery.list-view {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .gallery-photo {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .gallery-photo:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #4CAF50;
        }
        
        .gallery-photo.grid-view {
            aspect-ratio: 1;
        }
        
        .gallery-photo.list-view {
            display: flex;
            padding: 10px;
            align-items: center;
            gap: 15px;
        }
        
        .gallery-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-photo.list-view img {
            width: 80px;
            height: 80px;
            border-radius: 6px;
        }
        

        
        .photo-preview {
            margin-top: 20px;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            overflow: hidden;
            background: white;
            max-height: none;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e8ed;
        }
        
        .preview-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .close-preview {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #64748b;
        }
        
        .preview-content {
            padding: 15px;
        }
        
        .preview-content img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .preview-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .preview-region {
            font-weight: bold;
            color: #4CAF50;
        }
        
        .preview-date {
            color: #64748b;
            font-size: 14px;
        }
        
        .preview-notes {
            color: #2c3e50;
            font-style: italic;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .preview-actions {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #e1e8ed;
        }
        
        .btn-compare,
        .btn-fullscreen {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-compare {
            background: #2196F3;
            color: white;
        }
        
        .btn-fullscreen {
            background: #FF9800;
            color: white;
        }
        
        .btn-compare:hover,
        .btn-fullscreen:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Overlay kamery */
        .camera-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        
        .zoom-controls {
            display: flex;
            gap: 5px;
        }
        
        .zoom-btn {
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .zoom-btn:hover {
            background: rgba(0,0,0,0.9);
        }
        
        /* Brak zdjęć */
        .no-photos {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-style: italic;
        }
        
        /* Pełnoekranowa galeria */
        .fullscreen-gallery-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f5f5f5;
            z-index: 10000;
            display: none;
            flex-direction: column;
        }
        
        .fullscreen-gallery-overlay.active {
            display: flex;
        }
        
        .fullscreen-gallery-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .fullscreen-gallery-header h2 {
            margin: 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .fullscreen-gallery-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .fullscreen-gallery-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .fullscreen-photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .fullscreen-photo-item {
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .fullscreen-photo-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .fullscreen-photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        

        
        .close-fullscreen-gallery {
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .close-fullscreen-gallery:hover {
            background: #d32f2f;
        }
        
        /* Responsywność */
        @media (min-width: 1600px) {
            #model-viewer-doc {
                height: 600px;
                min-height: 500px;
            }
        }
        
        @media (max-width: 1400px) {
            .documentation-mode.active {
                grid-template-columns: 450px 1fr 300px;
            }
            
            .doc-panel {
                min-height: 500px;
            }
        }
        
        @media (max-width: 1200px) and (min-width: 1025px) {
            #model-viewer-doc {
                height: 450px;
                min-height: 350px;
            }
        }
        
        @media (max-width: 1024px) {
            .trichoscopy-container {
                margin-left: 80px;
            }
            
            .presentation-layout {
                flex-direction: column;
                height: auto;
            }
            
            .documentation-mode.active {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                height: auto;
                overflow: visible;
            }
            
            .camera-preview {
                height: 300px;
            }
            
            .photo-gallery.grid-view {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            #model-viewer-doc {
                height: 400px;
                min-height: 300px;
            }
            
            .doc-panel {
                min-height: auto;
                height: auto;
            }
        }
        
        @media (max-width: 768px) {
            #model-viewer-doc {
                height: 350px;
                min-height: 280px;
            }
            
            .doc-panel {
                min-height: auto;
                height: auto;
                padding: 15px;
            }
            
            .trichoscopy-container {
                margin-left: 0;
            }
            
            .trichoscopy-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .presentation-layout {
                padding: 15px;
                gap: 15px;
            }
            
            .camera-main {
                min-height: 250px;
            }
            
            .documentation-mode {
                padding: 15px;
            }
            
            .documentation-mode.active {
                height: auto;
                overflow: visible;
            }
            
            .camera-controls {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .control-btn {
                padding: 10px 12px;
                font-size: 12px;
            }
        }
        
        /* Fullscreen styles */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            display: none;
        }
        
        .fullscreen-overlay.active {
            display: block;
        }
        
        .fullscreen-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .fullscreen-controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
        }
        
        .fullscreen-controls .control-btn {
            background: rgba(0,0,0,0.8);
            padding: 15px 20px;
            font-size: 16px;
        }
        
        .exit-fullscreen {
            background: #f44336 !important;
        }
        
        /* Specjalne style dla przycisku pełny ekran */
        #goFullscreenDoc {
            background: #2196F3 !important;
            color: white !important;
            border: 2px solid #1976D2 !important;
            z-index: 100 !important;
            position: relative !important;
            display: block !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }
        
        #goFullscreenDoc:hover {
            background: #1976D2 !important;
            border-color: #1565C0 !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <i class="fas fa-user-md fa-2x" style="color: white;"></i>
            <span>Trichology</span>
        </div>
        
        <nav>
            <a href="/" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="/documentation_form" class="nav-item">
                <i class="fas fa-user-plus"></i>
                <span>Nowy Pacjent</span>
            </a>
            <a href="/polecane-produkty" class="nav-item">
                <i class="fas fa-box"></i>
                <span>Produkty</span>
            </a>
            <a href="/polecani-fryzjerzy" class="nav-item">
                <i class="fas fa-cut"></i>
                <span>Fryzjerzy</span>
            </a>
            <a href="/polecane-kliniki" class="nav-item">
                <i class="fas fa-hospital"></i>
                <span>Kliniki</span>
            </a>
            <a href="/settings" class="nav-item">
                <i class="fas fa-cog"></i>
                <span>Ustawienia</span>
            </a>
        </nav>
    </aside>

    <div class="trichoscopy-container">
        <!-- Nagłówek -->
        <header class="trichoscopy-header">
            <div class="patient-info">
                <h1>Trychoskopia</h1>
                <p>{{ patient.name }} {{ patient.surname }} (PESEL: {{ patient.pesel }})</p>
            </div>
            
            <div class="mode-switcher">
                <button class="mode-btn" data-mode="presentation">
                    <i class="fas fa-eye"></i> Prezentacja
                </button>
                <button class="mode-btn active" data-mode="documentation">
                    <i class="fas fa-camera"></i> Dokumentacja
                </button>
            </div>
            

            
            <div class="header-actions">
                <a href="{{ url_for('patient', pesel=patient.pesel) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Powrót
                </a>
            </div>
        </header>

        <!-- Główny obszar -->
        <main class="main-area">
            <!-- TRYB PREZENTACJI -->
            <div class="presentation-mode">
                <div class="presentation-layout">
                    <div class="camera-main">
                        <video id="cameraPreview" autoplay playsinline muted></video>
                        <div class="camera-controls">
                            <button class="control-btn" id="zoomOutBtn">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <button class="control-btn" id="zoomInBtn">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="control-btn" id="toggleGrid">
                                <i class="fas fa-th"></i> Siatka
                            </button>
                            <button class="control-btn fullscreen-btn" id="goFullscreen">
                                <i class="fas fa-expand"></i> Pełny ekran
                            </button>
                        </div>
                    </div>
                    
                    <div class="model-sidebar">
                        <h3><i class="fas fa-cube"></i> Model głowy</h3>
                        <div id="model-viewer-presentation"></div>
                        <div class="model-instructions">
                            <h4>Instrukcje:</h4>
                            <ul class="instruction-list">
                                <li><i class="fas fa-hand-paper"></i> Przeciągnij - obróć model</li>
                                <li><i class="fas fa-scroll"></i> Scroll - przybliż/oddal</li>
                                <li><i class="fas fa-mouse-pointer"></i> Kliknij - zaznacz obszar</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRYB DOKUMENTACJI -->
            <div class="documentation-mode active">
                <!-- Panel modelu 3D -->
                <div class="doc-panel">
                    <h3><i class="fas fa-cube"></i> Zaznacz obszar na modelu</h3>
                    <div id="model-viewer-doc">
                        <div class="model-loading" id="model-loading-doc">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Ładowanie modelu 3D...</p>
                        </div>
                                        </div>
                    
                    <div class="selected-region">
                        <h4>Wybrany obszar:</h4>
                        <div class="region-name" id="selectedRegionName">Nie wybrano</div>
                    </div>
                    
                    <div class="model-instructions">
                        <h4>Jak używać:</h4>
                        <ul class="instruction-list">
                            <li><i class="fas fa-mouse-pointer"></i> Kliknij na model, aby wybrać obszar</li>
                            <li><i class="fas fa-camera"></i> Zrób zdjęcie w środkowym panelu</li>
                            <li><i class="fas fa-images"></i> Przeglądaj galerię w prawym panelu</li>
                        </ul>
                    </div>
                    

                </div>
                
                <!-- Panel kamery -->
                <div class="doc-panel camera-doc-panel">
                    <h3><i class="fas fa-camera"></i> Kamera trychoskopowa</h3>
                    
                    <div class="camera-preview">
                        <video id="cameraPreviewDoc" autoplay playsinline muted></video>
                        <div class="camera-overlay">
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoomOutDocBtn">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                                <button class="zoom-btn" id="zoomInDocBtn">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button class="zoom-btn" id="toggleGridDoc">
                                    <i class="fas fa-th"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="photo-controls">
                        <button class="photo-btn primary" id="capturePhoto">
                            <i class="fas fa-camera"></i> Zrób zdjęcie
                        </button>
                        <button class="photo-btn secondary" id="switchCamera">
                            <i class="fas fa-sync"></i> Zmień kamerę
                        </button>
                        <button class="photo-btn secondary" id="goFullscreenDoc" onclick="handleFullscreenClick()">
                            <i class="fas fa-expand"></i> Pełny ekran
                        </button>
                    </div>
                    
                    <div class="note-section">
                        <label for="photoNote">Opis obserwacji:</label>
                        <textarea id="photoNote" placeholder="Opisz co widzisz: stan skóry, gęstość włosów, zmiany chorobowe..."></textarea>
                    </div>
                </div>
                
                <!-- Panel galerii -->
                <div class="doc-panel gallery-panel">
                    <div class="gallery-header">
                        <h3><i class="fas fa-images"></i> Galeria zdjęć</h3>
                        <button class="btn-fullscreen-gallery" onclick="openFullscreenGallery()">
                            <i class="fas fa-expand"></i> Pełna galeria
                        </button>
                    </div>
                    
                    <!-- Kontrolki galerii -->
                    <div class="gallery-controls">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid">
                                <i class="fas fa-th"></i> Siatka
                            </button>
                            <button class="view-btn" data-view="list">
                                <i class="fas fa-list"></i> Lista
                            </button>
                        </div>
                        <div class="filter-controls">
                            <select id="photoFilter" class="filter-select">
                                <option value="all">Wszystkie</option>
                                <option value="today">Dzisiaj</option>
                                <option value="week">Tydzień</option>
                                <option value="month">Miesiąc</option>
                                <option value="3months">3 miesiące</option>
                            </select>
                        </div>
                        <div class="sort-controls">
                            <select id="sortBy" class="sort-select">
                                <option value="newest">Najnowsze</option>
                                <option value="oldest">Najstarsze</option>
                                <option value="region">Według regionu</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Galeria zdjęć -->
                    <div id="photoGallery" class="photo-gallery grid-view">
                        <!-- Zdjęcia będą dodawane tutaj -->
                    </div>
                    
                    <!-- Podgląd wybranego zdjęcia -->
                    <div id="photoPreview" class="photo-preview" style="display: none;">
                        <div class="preview-header">
                            <h4>Podgląd zdjęcia</h4>
                            <button class="close-preview" onclick="closePhotoPreview()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="preview-content">
                            <img id="previewImage" src="" alt="Podgląd">
                            <div class="preview-info">
                                <div class="preview-region"></div>
                                <div class="preview-date"></div>
                                <div class="preview-notes"></div>
                            </div>
                        </div>
                        <div class="preview-actions">
                            <button class="btn-compare" onclick="selectForComparison()">
                                <i class="fas fa-balance-scale"></i> Porównaj
                            </button>
                            <button class="btn-fullscreen" onclick="showFullscreenPhoto()">
                                <i class="fas fa-expand"></i> Pełny ekran
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Fullscreen overlay -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <video id="fullscreenVideo" class="fullscreen-video" autoplay playsinline muted></video>
        <div class="fullscreen-controls">
            <button class="control-btn" id="fullscreenZoomOut">
                <i class="fas fa-search-minus"></i>
            </button>
            <button class="control-btn" id="fullscreenZoomIn">
                <i class="fas fa-search-plus"></i>
            </button>
            <button class="control-btn" id="fullscreenToggleGrid">
                <i class="fas fa-th"></i> Siatka
            </button>
            <button class="control-btn exit-fullscreen" id="exitFullscreen">
                <i class="fas fa-times"></i> Zamknij
            </button>
        </div>
    </div>

    <!-- Pełnoekranowa galeria -->
    <div class="fullscreen-gallery-overlay" id="fullscreenGalleryOverlay">
        <div class="fullscreen-gallery-header">
            <h2><i class="fas fa-images"></i> Galeria zdjęć trychoskopowych</h2>
            <div class="fullscreen-gallery-controls">
                <!-- Filtry -->
                <select id="fullscreenPhotoFilter" class="filter-select">
                    <option value="all">Wszystkie zdjęcia</option>
                    <option value="today">Dzisiaj</option>
                    <option value="week">Ostatni tydzień</option>
                    <option value="month">Ostatni miesiąc</option>
                    <option value="3months">Ostatnie 3 miesiące</option>
                </select>
                
                <!-- Sortowanie -->
                <select id="fullscreenSortBy" class="sort-select">
                    <option value="newest">Najnowsze</option>
                    <option value="oldest">Najstarsze</option>
                    <option value="region">Według regionu A-Z</option>
                    <option value="region-desc">Według regionu Z-A</option>
                    <option value="czolo">Tylko czoło</option>
                    <option value="potylica">Tylko potylica</option>
                    <option value="boki">Tylko boki głowy</option>
                    <option value="ciemie">Tylko ciemię</option>
                    <option value="zakola">Tylko zakola</option>
                    <option value="skronie">Tylko skronie</option>
                </select>
                
                <!-- Panel porównywania -->
                <div id="fullscreenComparisonPanel" style="
                    display: none;
                    background: rgba(255,255,255,0.95);
                    border: 2px solid #2196F3;
                    border-radius: 8px;
                    padding: 12px;
                    margin: 0 15px;
                    flex-grow: 1;
                    max-width: 300px;
                ">
                    <div style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin-bottom: 8px;
                    ">
                        <i class="fas fa-compare" style="color: #2196F3;"></i>
                        <span style="font-weight: 600; color: #333;">Porównywanie (<span id="fullscreenComparisonCount">0</span>/2)</span>
                        <button onclick="clearComparison()" style="
                            background: #f44336;
                            color: white;
                            border: none;
                            padding: 4px 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 11px;
                            margin-left: auto;
                        ">×</button>
                    </div>
                    <div id="fullscreenSelectedPhotos" style="
                        display: flex;
                        gap: 8px;
                        margin-bottom: 8px;
                    "></div>
                    <div id="fullscreenComparisonActions" style="
                        display: flex;
                        gap: 8px;
                        justify-content: center;
                    "></div>
                </div>
                
                <!-- Upload zdjęć -->
                <button class="upload-photo-btn" onclick="openUploadModal()" style="
                    background: #28a745;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-right: 10px;
                ">
                    <i class="fas fa-camera"></i>
                    Dodaj zdjęcie
                </button>
                
                <!-- Zamknij -->
                <button class="close-fullscreen-gallery" onclick="closeFullscreenGallery()">
                    <i class="fas fa-times"></i> Zamknij
                </button>
            </div>
        </div>
        
        <div class="fullscreen-gallery-content">
            <div id="fullscreenPhotoGrid" class="fullscreen-photo-grid">
                <!-- Zdjęcia będą dodawane tutaj -->
            </div>
        </div>
    </div>

    <!-- Modal uploadu zdjęć -->
    <div id="uploadModal" class="upload-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.8);
        z-index: 12000;
        display: flex;
        align-items: center;
        justify-content: center;
    ">
        <div class="upload-modal-content" style="
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        ">
            <div class="upload-modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            ">
                <h3 style="margin: 0; color: #2c3e50;">
                    <i class="fas fa-camera"></i>
                    Dodaj nowe zdjęcie
                </h3>
                <button onclick="closeUploadModal()" style="
                    background: none;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #666;
                ">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="upload-modal-body">
                <!-- Wybór typu zdjęcia -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        <i class="fas fa-camera"></i>
                        Typ zdjęcia:
                    </label>
                    <select id="uploadPhotoType" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="trichoscopy">Trychoskopia</option>
                        <option value="clinical">Obraz kliniczny</option>
                    </select>
                </div>
                
                <!-- Wybór regionu (tylko dla trychoskopii) -->
                <div id="regionSelectContainer" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        <i class="fas fa-map-marker-alt"></i>
                        Wybierz region:
                    </label>
                    <select id="uploadRegionSelect" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                        <option value="">-- Wybierz region --</option>
                        <option value="Czoło górne">Czoło górne</option>
                        <option value="Czoło dolne">Czoło dolne</option>
                        <option value="Czoło lewe">Czoło lewe</option>
                        <option value="Czoło prawe">Czoło prawe</option>
                        <option value="Czoło dolne lewe">Czoło dolne lewe</option>
                        <option value="Czoło dolne prawe">Czoło dolne prawe</option>
                        <option value="Potylica">Potylica</option>
                        <option value="Ciemię">Ciemię</option>
                        <option value="Zakola lewe">Zakola lewe</option>
                        <option value="Zakola prawe">Zakola prawe</option>
                        <option value="Skronie lewe">Skronie lewe</option>
                        <option value="Skronie prawe">Skronie prawe</option>
                        <option value="Boki głowy lewe">Boki głowy lewe</option>
                        <option value="Boki głowy prawe">Boki głowy prawe</option>
                    </select>
                </div>
                
                <!-- Notatka -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        <i class="fas fa-sticky-note"></i>
                        Notatka (opcjonalnie):
                    </label>
                    <textarea id="uploadNote" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 14px;
                        min-height: 80px;
                        resize: vertical;
                    " placeholder="Dodaj notatkę do zdjęcia..."></textarea>
                </div>
                
                <!-- Upload pliku -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">
                        <i class="fas fa-upload"></i>
                        Wybierz zdjęcie:
                    </label>
                    <input type="file" id="uploadPhotoFile" accept="image/*" style="
                        width: 100%;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 14px;
                    ">
                    <div id="uploadPreview" style="
                        margin-top: 10px;
                        text-align: center;
                        display: none;
                    ">
                        <img id="uploadPreviewImg" style="
                            max-width: 100%;
                            max-height: 200px;
                            border-radius: 6px;
                            border: 1px solid #ddd;
                        ">
                    </div>
                </div>
                
                <!-- Przyciski akcji -->
                <div style="
                    display: flex;
                    gap: 10px;
                    justify-content: flex-end;
                    margin-top: 20px;
                ">
                    <button onclick="closeUploadModal()" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                    ">
                        Anuluj
                    </button>
                    <button onclick="uploadPhoto()" id="uploadPhotoBtn" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                    " disabled>
                        <i class="fas fa-upload"></i>
                        Dodaj zdjęcie
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/photo-editor.js"></script>
    <script>
        
        // Funkcja backup dla onclick
        function handleFullscreenClick() {
            console.log('*** ONCLICK PEŁNY EKRAN KLIKNIĘTY ***');
            
            const video = document.getElementById('cameraPreviewDoc');
            console.log('Video element (onclick):', video);
            console.log('Video srcObject (onclick):', video ? video.srcObject : 'brak video');
            
            if (video && video.srcObject) {
                console.log('Przechodzenie do pełnego ekranu z onclick');
                const fullscreenVideo = document.getElementById('fullscreenVideo');
                const fullscreenOverlay = document.getElementById('fullscreenOverlay');
                
                console.log('Fullscreen video (onclick):', fullscreenVideo);
                console.log('Fullscreen overlay (onclick):', fullscreenOverlay);
                
                if (fullscreenVideo && fullscreenOverlay) {
                    fullscreenVideo.srcObject = video.srcObject;
                    fullscreenOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    console.log('Pełny ekran aktywowany przez onclick');
                    
                    // Upewnij się, że overflow zostanie przywrócony
                    const restoreOverflow = () => {
                        if (!fullscreenOverlay.classList.contains('active')) {
                            document.body.style.overflow = 'auto';
                        }
                    };
                    
                    // Obserwuj zmiany w klasie active
                    const observer = new MutationObserver(restoreOverflow);
                    observer.observe(fullscreenOverlay, { attributes: true, attributeFilter: ['class'] });
                } else {
                    console.error('Brak elementów pełnoekranowych (onclick)');
                }
            } else {
                console.error('Video element lub strumień kamery nie jest dostępny (onclick)');
                console.error('Video element istnieje (onclick):', !!video);
                console.error('Video srcObject istnieje (onclick):', !!(video && video.srcObject));
                alert('Kamera nie jest dostępna');
            }
        }
        
        // Zmienne globalne
        let currentMode = 'documentation';
        let currentStream = null;
        let selectedRegion = null;
        let capturedPhotos = [];
        let currentZoom = 1;
        let presentationZoom = 1;
        let documentationZoom = 1;
        let scene, camera, renderer, model;
        let sceneDoc, cameraDoc, rendererDoc, modelDoc;
        let documentationModelInitialized = false;
        let trichoscopyMarkers = []; // Przechowuje wszystkie markery trychoskopii
        let currentDocScene = null; // Referencja do sceny dokumentacji
        let historicalPhotos = []; // Przechowuje wszystkie historyczne zdjęcia z serwera
        let currentPhotoFilter = 'all'; // Filtr dat: 'all', 'today', 'week', 'month', 'custom'
        let availableCameras = []; // Lista dostępnych kamer
        let currentCameraIndex = 0; // Indeks aktualnie używanej kamery
        let selectedPhotosForComparison = []; // Zdjęcia wybrane do porównania

        
        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM załadowany, inicjalizacja aplikacji...');
            
            // WZMOCNIONE MECHANIZMY SCROLLOWANIA
            // Wymuś overflow na wszystkich potrzebnych elementach
            document.body.style.overflow = 'auto';
            document.body.style.overflowY = 'auto';
            document.documentElement.style.overflow = 'auto';
            document.documentElement.style.overflowY = 'auto';
            
            // Znajdź i popraw main-area
            const mainArea = document.querySelector('.main-area');
            if (mainArea) {
                mainArea.style.overflow = 'visible';
                mainArea.style.overflowY = 'visible';
            }
            
            // Znajdź i popraw trichoscopy-container
            const trichoscopyContainer = document.querySelector('.trichoscopy-container');
            if (trichoscopyContainer) {
                trichoscopyContainer.style.overflow = 'visible';
                trichoscopyContainer.style.overflowY = 'visible';
            }
            
            // Znajdź i popraw documentation-mode
            const docModeContainer = document.querySelector('.documentation-mode');
            if (docModeContainer) {
                docModeContainer.style.overflow = 'visible';
                docModeContainer.style.overflowY = 'visible';
            }
            
            // Dodaj mechanizm bezpieczeństwa - przywracaj overflow po każdym kliknięciu
            document.addEventListener('click', function() {
                setTimeout(() => {
                    const overlays = document.querySelectorAll('.fullscreen-overlay, .modal');
                    let anyOverlayActive = false;
                    
                    overlays.forEach(overlay => {
                        if (overlay.classList.contains('active') || overlay.style.display === 'block') {
                            anyOverlayActive = true;
                        }
                    });
                    
                    if (!anyOverlayActive) {
                        document.body.style.overflow = 'auto';
                        document.body.style.overflowY = 'auto';
                        document.documentElement.style.overflow = 'auto';
                        document.documentElement.style.overflowY = 'auto';
                        
                        // Dodatkowo popraw główne kontenery
                        const mainArea = document.querySelector('.main-area');
                        if (mainArea) {
                            mainArea.style.overflow = 'visible';
                            mainArea.style.overflowY = 'visible';
                        }
                        
                        const docModeElem = document.querySelector('.documentation-mode');
                        if (docModeElem) {
                            docModeElem.style.overflow = 'visible';
                            docModeElem.style.overflowY = 'visible';
                        }
                    }
                }, 100);
            });
            
            // Dodatkowy mechanizm bezpieczeństwa - co 2 sekundy sprawdzaj overflow
            setInterval(() => {
                const modals = document.querySelectorAll('.modal');
                const overlays = document.querySelectorAll('.fullscreen-overlay.active');
                
                if (modals.length === 0 && overlays.length === 0) {
                    document.body.style.overflow = 'auto';
                    document.body.style.overflowY = 'auto';
                    document.documentElement.style.overflow = 'auto';
                    document.documentElement.style.overflowY = 'auto';
                    
                    // Dodatkowo popraw główne kontenery
                    const mainArea = document.querySelector('.main-area');
                    if (mainArea) {
                        mainArea.style.overflow = 'visible';
                        mainArea.style.overflowY = 'visible';
                    }
                    
                                         const docModeEl = document.querySelector('.documentation-mode');
                     if (docModeEl) {
                         docModeEl.style.overflow = 'visible';
                         docModeEl.style.overflowY = 'visible';
                     }
                }
            }, 2000);
            
            // Przywróć overflow na ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    setTimeout(() => {
                        document.body.style.overflow = 'auto';
                        document.body.style.overflowY = 'auto';
                        document.documentElement.style.overflow = 'auto';
                        document.documentElement.style.overflowY = 'auto';
                    }, 200);
                }
            });
            
            // Sprawdź początkowy stan trybu
            const documentationMode = document.querySelector('.documentation-mode');
            const presentationMode = document.querySelector('.presentation-mode');
            console.log('Tryb dokumentacji aktywny:', documentationMode.classList.contains('active'));
            console.log('Tryb prezentacji aktywny:', presentationMode.classList.contains('active'));
            
            // Sprawdź czy przycisk istnieje przed inicjalizacją
            const goFullscreenDocBtn = document.getElementById('goFullscreenDoc');
            console.log('Przycisk goFullscreenDoc na początku:', goFullscreenDocBtn);
            
            initializeModeSwitch();
            
            // Sprawdź dostępność MediaDevices API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Twoja przeglądarka nie obsługuje dostępu do kamery');
                return;
            }
            
            initializeCamera();
            initializeModels();
            initializeFullscreen();
            initializeGallery();
            
            // Ładowanie historycznych zdjęć
            setTimeout(() => {
                loadHistoricalPhotos().then(() => {
                    console.log('Historyczne zdjęcia załadowane');
                }).catch(error => {
                    console.error('Błąd ładowania historycznych zdjęć:', error);
                    renderGallery();
                });
            }, 500);
            
            // Backup mechanizmy
            setTimeout(() => {
                renderGallery();
            }, 2000);
            
            setTimeout(() => {
                if (historicalPhotos.length === 0) {
                    loadHistoricalPhotos();
                } else {
                    renderGallery();
                }
            }, 5000);
            
            // Dodaj dodatkowe sprawdzenie przycisku po wszystkich inicjalizacjach
            setTimeout(() => {
                const btn = document.getElementById('goFullscreenDoc');
                console.log('Przycisk goFullscreenDoc po inicjalizacji:', btn);
                if (btn) {
                    console.log('Przycisk style po inicjalizacji:', window.getComputedStyle(btn));
                    console.log('Przycisk parent:', btn.parentElement);
                    console.log('Przycisk visible:', btn.offsetWidth > 0 && btn.offsetHeight > 0);
                }
            }, 1000);
            
            console.log('Aplikacja zainicjalizowana pomyślnie');
        });
        
        // Przełączanie trybu
        function initializeModeSwitch() {
            const modeButtons = document.querySelectorAll('.mode-btn');
            const presentationMode = document.querySelector('.presentation-mode');
            const documentationMode = document.querySelector('.documentation-mode');
            
            // Inicjalizacja domyślnego stanu - tryb dokumentacji jest aktywny
            if (documentationMode && !documentationMode.classList.contains('active')) {
                documentationMode.classList.add('active');
            }
            if (presentationMode && presentationMode.classList.contains('active')) {
                presentationMode.classList.remove('active');
            }
            
            // Upewnij się, że przycisk dokumentacji jest aktywny
            const docButton = document.querySelector('.mode-btn[data-mode="documentation"]');
            const presButton = document.querySelector('.mode-btn[data-mode="presentation"]');
            if (docButton && !docButton.classList.contains('active')) {
                docButton.classList.add('active');
            }
            if (presButton && presButton.classList.contains('active')) {
                presButton.classList.remove('active');
            }
            
            modeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    
                    // Aktualizuj przyciski
                    modeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Przełącz tryby
                    if (mode === 'presentation') {
                        presentationMode.classList.add('active');
                        documentationMode.classList.remove('active');
                        currentMode = 'presentation';
                        console.log('Przełączono na tryb prezentacji');
                    } else {
                        presentationMode.classList.remove('active');
                        documentationMode.classList.add('active');
                        currentMode = 'documentation';
                        console.log('Przełączono na tryb dokumentacji');
                        
                        // Sprawdź czy przycisk jest widoczny po przełączeniu
                        setTimeout(() => {
                            const btn = document.getElementById('goFullscreenDoc');
                            console.log('Przycisk goFullscreenDoc po przełączeniu na dokumentację:', btn);
                            if (btn) {
                                console.log('Przycisk widoczny:', btn.offsetWidth > 0 && btn.offsetHeight > 0);
                                console.log('Przycisk style:', window.getComputedStyle(btn).display);
                            }
                        }, 100);
                        
                        // Inicjalizuj model dokumentacji tylko raz
                        if (!documentationModelInitialized) {
                            setTimeout(() => {
                                console.log('Inicjalizacja modelu dokumentacji po przełączeniu trybu');
                                initModel('model-viewer-doc', 'documentation');
                                documentationModelInitialized = true;
                            }, 100);
                        }
                        
                        // Reinicjalizuj event listenery dla przycisków dokumentacji
                        setTimeout(() => {
                            initializeCameraControls();
                        }, 200);
                    }
                    
                    // Reinicjalizuj kamerę dla nowego trybu
                    setTimeout(() => {
                        initializeCamera();
                    }, 100);
                });
            });
        }
        

        
        // Inicjalizacja kamery
        async function initializeCamera() {
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // Pobierz listę dostępnych kamer
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                console.log('Dostępne kamery:', availableCameras.length);
                availableCameras.forEach((camera, index) => {
                    console.log(`Kamera ${index}: ${camera.label || 'Nieznana kamera'}`);
                });
                
                if (availableCameras.length === 0) {
                    alert('Nie znaleziono żadnych kamer');
                    return;
                }
                
                const constraints = {
                    video: {
                        deviceId: availableCameras[currentCameraIndex]?.deviceId ? 
                            { exact: availableCameras[currentCameraIndex].deviceId } : undefined,
                        // Maxymalna jakość dla iPhone i innych urządzeń
                        width: { 
                            min: 1280,
                            ideal: 4096,  // 4K dla iPhone Pro
                            max: 4096 
                        },
                        height: { 
                            min: 720,
                            ideal: 2160,  // 4K dla iPhone Pro
                            max: 2160 
                        },
                        // Dodatkowe ustawienia dla najlepszej jakości
                        frameRate: { ideal: 30, max: 60 },
                        facingMode: availableCameras.length === 1 ? 'environment' : undefined,
                        // Ustawienia specificzne dla iPhone i wysokiej jakości
                        aspectRatio: { ideal: 16/9 },
                        resizeMode: 'none',  // Nie zmieniaj rozmiaru
                        // Dodatkowe constraints dla lepszej jakości
                        whiteBalanceMode: 'auto',
                        exposureMode: 'auto',
                        focusMode: 'auto'
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoElement = currentMode === 'presentation' 
                    ? document.getElementById('cameraPreview')
                    : document.getElementById('cameraPreviewDoc');
                
                if (videoElement) {
                    videoElement.srcObject = currentStream;
                    // Resetuj zoom-y video
                    videoElement.style.transform = 'scale(1)';
                    videoElement.style.transformOrigin = 'center center';
                    console.log('Kamera podłączona do elementu video');
                    
                    // Sprawdź i wyświetl rzeczywistą jakość video
                    setTimeout(() => {
                        checkVideoQuality(videoElement);
                    }, 1000);
                } else {
                    console.error('Nie znaleziono elementu video dla trybu:', currentMode);
                }
                
                console.log('Kamera zainicjalizowana dla trybu:', currentMode);
                showNotification('Kamera została zainicjalizowana', 'success');
                
            } catch (error) {
                console.error('Błąd inicjalizacji kamery:', error);
                alert('Nie można uzyskać dostępu do kamery: ' + error.message);
            }
        }
        
        // Inicjalizacja modeli 3D
        function initializeModels() {
            // Model dla trybu prezentacji
            initModel('model-viewer-presentation', 'presentation');
            
            // Model dla trybu dokumentacji - domyślny tryb
            initModel('model-viewer-doc', 'documentation');
            documentationModelInitialized = true;
        }
        
        function initModel(containerId, mode) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error('Kontener nie znaleziony:', containerId);
                return;
            }
            
            console.log('Inicjalizacja modelu dla:', containerId, 'tryb:', mode);
            console.log('Rozmiary kontenera:', container.clientWidth, 'x', container.clientHeight);
            
            // Wymuś rozmiary jeśli kontener jest niewidoczny
            if (container.clientWidth === 0 || container.clientHeight === 0) {
                console.log('Kontener ma rozmiary 0x0, wymuszam rozmiary');
                container.style.width = '100%';
                container.style.height = '300px';
                container.style.display = 'block';
                
                // Sprawdź ponownie rozmiary po wymuszeniu
                setTimeout(() => {
                    console.log('Rozmiary po wymuszeniu:', container.clientWidth, 'x', container.clientHeight);
                }, 10);
            }
            
            // Podstawowa konfiguracja Three.js
            const scene = new THREE.Scene();
            const width = container.clientWidth || 400;
            const height = container.clientHeight || 300;
            
            // Ustaw referencję globalną dla trybu dokumentacji
            if (mode === 'documentation') {
                currentDocScene = scene;
                console.log('Ustawiono currentDocScene dla trybu dokumentacji');
            }
            const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            
            console.log('Ustawianie rozmiaru renderera:', width, 'x', height);
            renderer.setSize(width, height);
            renderer.setClearColor(0xf0f0f0);
            
            // Wyczyść kontener przed dodaniem renderera
            container.innerHTML = '';
            container.appendChild(renderer.domElement);
            
            console.log('Renderer dodany do kontenera:', containerId);
            console.log('Canvas dodany o rozmiarach:', renderer.domElement.width, 'x', renderer.domElement.height);
            
            // Oświetlenie
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Ładowanie modelu GLB
            const loader = new THREE.GLTFLoader();
            let headModel = null;
            
            console.log('Rozpoczęcie ładowania modelu GLB dla:', mode);
            loader.load('/static/models/1.glb', function(gltf) {
                headModel = gltf.scene;
                headModel.scale.set(1.2, 1.2, 1.2);
                headModel.position.set(0, -1, 0);
                
                // Włącz cienie dla wszystkich mesh'y w modelu
                headModel.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                
                scene.add(headModel);
                console.log('Model głowy załadowany pomyślnie dla:', mode);
                console.log('Scena zawiera obiektów:', scene.children.length);
                
                // Usuń wskaźnik ładowania i załaduj markery dla trybu dokumentacji
                if (mode === 'documentation') {
                    const loadingIndicator = document.getElementById('model-loading-doc');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    // Załaduj zapisane markery trychoskopii i historyczne
                    setTimeout(() => {
                        loadTrichoscopyMarkers();
                        createHistoricalMarkers();
                    }, 100);
                }
            }, function(progress) {
                console.log('Ładowanie modelu ' + mode + ': ' + (progress.loaded / progress.total * 100) + '%');
            }, function(error) {
                console.error('Błąd ładowania modelu dla ' + mode + ':', error);
                // Fallback - użyj prostej sfery
                const geometry = new THREE.SphereGeometry(1, 32, 32);
                const material = new THREE.MeshLambertMaterial({ color: 0xfdbcb4 });
                const sphere = new THREE.Mesh(geometry, material);
                scene.add(sphere);
                console.log('Użyto fallback modelu (sfera) dla:', mode);
                console.log('Scena zawiera obiektów:', scene.children.length);
                
                // Usuń wskaźnik ładowania
                if (mode === 'documentation') {
                    const loadingIndicator = document.getElementById('model-loading-doc');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                }
            });
            
            // Pozycja kamery
            camera.position.set(0, 0, 3);
            
            // Kontrolki
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Obsługa kliknięć dla trybu dokumentacji
            if (mode === 'documentation') {
                renderer.domElement.addEventListener('click', (event) => {
                    const rect = renderer.domElement.getBoundingClientRect();
                    const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    const raycaster = new THREE.Raycaster();
                    raycaster.setFromCamera(new THREE.Vector2(x, y), camera);
                    
                    // Sprawdź kolizje z wszystkimi obiektami
                    const intersects = raycaster.intersectObjects(scene.children, true);
                    
                    if (intersects.length > 0) {
                        const intersectedObject = intersects[0].object;
                        
                        // Sprawdź czy kliknięto na marker trychoskopii (nowy lub historyczny)
                        if (intersectedObject.userData && (intersectedObject.userData.type === 'trichoscopy_marker' || intersectedObject.userData.type === 'historical_marker')) {
                            showMarkerInfo(intersectedObject.userData.photoData);
                            return;
                        }
                        
                        // Jeśli nie kliknięto na marker, wybierz region
                        const point = intersects[0].point;
                        selectRegion(point);
                    }
                });
            }
            
            // Animacja
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
            
            // Resize handler
            window.addEventListener('resize', () => {
                if (container.clientWidth > 0) {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
            });
        }
        
        // Wybór regionu na modelu
        function selectRegion(point) {
            selectedRegion = {
                x: point.x,
                y: point.y,
                z: point.z,
                name: getRegionName(point)
            };
            
            document.getElementById('selectedRegionName').textContent = selectedRegion.name;
            console.log('Wybrano region:', selectedRegion);
            
            // Dodaj tymczasowy marker do wizualizacji wybranego miejsca
            addTemporaryMarker(point);
        }
        
        // Dodaj tymczasowy marker (czerwony, pulsujący)
        function addTemporaryMarker(point) {
            if (!currentDocScene) return;
            
            // Usuń poprzedni tymczasowy marker
            const existingTemp = currentDocScene.getObjectByName('tempMarker');
            if (existingTemp) {
                currentDocScene.remove(existingTemp);
            }
            
            // Stwórz nowy tymczasowy marker
            const markerGeometry = new THREE.SphereGeometry(0.05, 16, 16);
            const markerMaterial = new THREE.MeshBasicMaterial({ 
                color: 0xff0000,
                transparent: true,
                opacity: 0.8
            });
            
            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
            marker.position.copy(point);
            marker.name = 'tempMarker';
            
            // Animacja pulsowania
            let pulseDirection = 1;
            const animate = () => {
                if (marker.parent) {
                    marker.scale.x += pulseDirection * 0.02;
                    marker.scale.y += pulseDirection * 0.02;
                    marker.scale.z += pulseDirection * 0.02;
                    
                    if (marker.scale.x > 1.5 || marker.scale.x < 0.8) {
                        pulseDirection *= -1;
                    }
                    
                    requestAnimationFrame(animate);
                }
            };
            animate();
            
            currentDocScene.add(marker);
        }
        
        // Dodaj trwały marker trychoskopii
        function addTrichoscopyMarker(point, photoData) {
            if (!currentDocScene) return;
            
            const markerId = 'marker_' + Date.now();
            
            // Stwórz marker
            const markerGeometry = new THREE.SphereGeometry(0.04, 16, 16);
            const markerMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x4CAF50, // Zielony dla zapisanych markerów
                transparent: true,
                opacity: 0.9
            });
            
            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
            marker.position.copy(point);
            marker.name = markerId;
            marker.userData = {
                type: 'trichoscopy_marker',
                photoData: photoData,
                position: { x: point.x, y: point.y, z: point.z }
            };
            
            // Dodaj pierścień wokół markera dla lepszej widoczności
            const ringGeometry = new THREE.RingGeometry(0.06, 0.08, 16);
            const ringMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x4CAF50,
                transparent: true,
                opacity: 0.5,
                side: THREE.DoubleSide
            });
            
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.position.copy(point);
            ring.lookAt(new THREE.Vector3(0, 0, 0)); // Skieruj pierścień w stronę środka głowy
            ring.name = markerId + '_ring';
            
            currentDocScene.add(marker);
            currentDocScene.add(ring);
            
            // Zapisz marker do tablicy
            trichoscopyMarkers.push({
                id: markerId,
                position: { x: point.x, y: point.y, z: point.z },
                photoData: photoData,
                timestamp: new Date().toISOString()
            });
            
            console.log('Dodano marker trychoskopii:', markerId, photoData);
            
            // Zapisz markery do localStorage dla trwałości
            saveTrichoscopyMarkers();
            
            // Aktualizuj listę markerów w interfejsie
            updateMarkersList();
        }
        
        // Zapisz markery do localStorage
        function saveTrichoscopyMarkers() {
            const patientId = window.location.pathname.split('/').pop();
            localStorage.setItem(`trichoscopy_markers_${patientId}`, JSON.stringify(trichoscopyMarkers));
        }
        
        // Pobierz historyczne zdjęcia z serwera
        async function loadHistoricalPhotos() {
            try {
                const patientId = window.location.pathname.split('/').pop();
                console.log('Ładowanie historycznych zdjęć dla pacjenta:', patientId);
                
                const response = await fetch(`/api/get-all-photos/${patientId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    historicalPhotos = Array.isArray(data) ? data : [];
                    console.log('Załadowano historyczne zdjęcia:', historicalPhotos.length);
                    
                    // Przekonwertuj zdjęcia na markery historyczne
                    createHistoricalMarkers();
                    
                    // Aktualizuj interfejs
                    updateHistoricalPhotosList();
                    updatePhotoFilters();
                    
                    // Renderuj galerię po załadowaniu historycznych zdjęć
                    renderGallery();
                } else {
                    console.error('Błąd pobierania zdjęć:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Błąd podczas pobierania historycznych zdjęć:', error);
            }
        }
        
        // Załaduj markery z localStorage
        function loadTrichoscopyMarkers() {
            const patientId = window.location.pathname.split('/').pop();
            const saved = localStorage.getItem(`trichoscopy_markers_${patientId}`);
            
            if (saved) {
                trichoscopyMarkers = JSON.parse(saved);
                console.log('Załadowano markery trychoskopii:', trichoscopyMarkers.length);
                
                // Odtwórz markery na scenie
                trichoscopyMarkers.forEach(markerData => {
                    recreateTrichoscopyMarker(markerData);
                });
                
                // Aktualizuj listę markerów w interfejsie
                updateMarkersList();
            }
        }
        
        // Aktualizuj listę markerów w interfejsie
        function updateMarkersList() {
            const container = document.getElementById('markersContainer');
            if (!container) return;
            
            // Filtruj markery według wybranego filtru
            const filteredMarkers = getFilteredMarkers();
            
            if (filteredMarkers.length === 0) {
                container.innerHTML = '<p class="no-markers">Brak markerów dla wybranego filtru</p>';
                return;
            }
            
            container.innerHTML = '';
            
            filteredMarkers.forEach(markerData => {
                const markerColor = getMarkerColorByDate(markerData.photoData.timestamp);
                const colorHex = '#' + markerColor.toString(16).padStart(6, '0');
                
                const markerElement = document.createElement('div');
                markerElement.className = 'marker-item';
                markerElement.style.borderLeft = `4px solid ${colorHex}`;
                markerElement.innerHTML = `
                    <div class="marker-info">
                        <div class="marker-region">${markerData.photoData.region}</div>
                        <div class="marker-timestamp">${markerData.photoData.timestamp}</div>
                        <div class="marker-notes">${markerData.photoData.notes || 'Brak notatek'}</div>
                        ${markerData.photoData.isHistorical ? '<div style="font-size: 11px; color: #666; font-style: italic;">Historyczne</div>' : ''}
                    </div>
                `;
                
                // Dodaj event listener do kliknięcia
                markerElement.addEventListener('click', () => {
                    showMarkerInfo(markerData.photoData);
                });
                
                container.appendChild(markerElement);
            });
        }
        
        // Pobierz przefiltrowane markery
        function getFilteredMarkers() {
            const filter = currentPhotoFilter;
            const today = new Date();
            
            return trichoscopyMarkers.filter(marker => {
                const markerDate = new Date(marker.photoData.timestamp);
                const daysDiff = Math.floor((today - markerDate) / (1000 * 60 * 60 * 24));
                
                switch(filter) {
                    case 'today':
                        return daysDiff === 0;
                    case 'week':
                        return daysDiff <= 7;
                    case 'month':
                        return daysDiff <= 30;
                    case '3months':
                        return daysDiff <= 90;
                    case 'all':
                    default:
                        return true;
                }
            });
        }
        
        // Aktualizuj filtry i event listenery
        function updatePhotoFilters() {
            const filterSelect = document.getElementById('photoFilter');
            if (!filterSelect) return;
            
            filterSelect.addEventListener('change', (e) => {
                currentPhotoFilter = e.target.value;
                updateMarkersList();
                updateMarkersVisibility();
            });
        }
        
        // Aktualizuj widoczność markerów na modelu 3D
        function updateMarkersVisibility() {
            if (!currentDocScene) return;
            
            const filteredMarkers = getFilteredMarkers();
            const filteredIds = filteredMarkers.map(m => m.id);
            
            // Ukryj wszystkie markery
            currentDocScene.children.forEach(child => {
                if (child.userData && (child.userData.type === 'trichoscopy_marker' || child.userData.type === 'historical_marker')) {
                    child.visible = filteredIds.includes(child.name);
                }
                if (child.name && (child.name.includes('marker_') || child.name.includes('historical_'))) {
                    child.visible = filteredIds.some(id => child.name.startsWith(id));
                }
            });
        }
        
        // Aktualizuj listę historycznych zdjęć
        function updateHistoricalPhotosList() {
            // Ta funkcja może być użyta do dodatkowego panelu z historycznymi zdjęciami
            console.log('Historyczne zdjęcia załadowane:', historicalPhotos.length);
        }
        
        // Odtwórz marker na scenie
        function recreateTrichoscopyMarker(markerData) {
            if (!currentDocScene) return;
            
            const point = new THREE.Vector3(markerData.position.x, markerData.position.y, markerData.position.z);
            
            // Stwórz marker
            const markerGeometry = new THREE.SphereGeometry(0.04, 16, 16);
            const markerMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x4CAF50,
                transparent: true,
                opacity: 0.9
            });
            
            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
            marker.position.copy(point);
            marker.name = markerData.id;
            marker.userData = {
                type: 'trichoscopy_marker',
                photoData: markerData.photoData,
                position: markerData.position
            };
            
            // Dodaj pierścień
            const ringGeometry = new THREE.RingGeometry(0.06, 0.08, 16);
            const ringMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x4CAF50,
                transparent: true,
                opacity: 0.5,
                side: THREE.DoubleSide
            });
            
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.position.copy(point);
            ring.lookAt(new THREE.Vector3(0, 0, 0));
            ring.name = markerData.id + '_ring';
            
            currentDocScene.add(marker);
            currentDocScene.add(ring);
        }
        
        // Stwórz markery historyczne z zdjęć z serwera
        function createHistoricalMarkers() {
            if (!historicalPhotos || historicalPhotos.length === 0) return;
            
            historicalPhotos.forEach(photo => {
                // Sprawdź czy zdjęcie ma informacje o pozycji z point data
                if (photo.point && photo.point.region) {
                    // Generuj losową pozycję na modelu 3D dla regionu (można to ulepszyć w przyszłości)
                    const position = {
                        x: (Math.random() - 0.5) * 2,
                        y: (Math.random() - 0.5) * 2,  
                        z: (Math.random() - 0.5) * 2
                    };
                    
                    const photoData = {
                        photoId: photo.id,
                        timestamp: photo.created_at,
                        notes: photo.note || '',
                        region: photo.head_region || 'Nieznany region',
                        filename: `historical_${photo.id}.jpg`,
                        imageUrl: photo.photo_url,
                        isHistorical: true
                    };
                    
                    // Sprawdź czy marker już istnieje (z localStorage)
                    const existingMarker = trichoscopyMarkers.find(m => 
                        m.photoData.photoId === photo.id
                    );
                    
                    if (!existingMarker) {
                        // Dodaj do tablicy markerów
                        trichoscopyMarkers.push({
                            id: 'historical_' + photo.id,
                            position: position,
                            photoData: photoData,
                            timestamp: photo.created_at,
                            isHistorical: true
                        });
                        
                        // Stwórz marker na scenie (jeśli scena jest gotowa)
                        if (currentDocScene) {
                            recreateHistoricalMarker(position, photoData);
                        }
                    }
                }
            });
            
            console.log('Utworzono markery historyczne:', trichoscopyMarkers.length);
        }
        
        // Odtwórz marker historyczny na scenie
        function recreateHistoricalMarker(position, photoData) {
            if (!currentDocScene) return;
            
            const point = new THREE.Vector3(position.x, position.y, position.z);
            const markerId = 'historical_' + photoData.photoId;
            
            // Różne kolory dla różnych okresów
            const markerColor = getMarkerColorByDate(photoData.timestamp);
            
            // Stwórz marker
            const markerGeometry = new THREE.SphereGeometry(0.04, 16, 16);
            const markerMaterial = new THREE.MeshBasicMaterial({ 
                color: markerColor,
                transparent: true,
                opacity: 0.8
            });
            
            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
            marker.position.copy(point);
            marker.name = markerId;
            marker.userData = {
                type: 'historical_marker',
                photoData: photoData,
                position: position
            };
            
            // Dodaj pierścień
            const ringGeometry = new THREE.RingGeometry(0.06, 0.08, 16);
            const ringMaterial = new THREE.MeshBasicMaterial({ 
                color: markerColor,
                transparent: true,
                opacity: 0.4,
                side: THREE.DoubleSide
            });
            
            const ring = new THREE.Mesh(ringGeometry, ringMaterial);
            ring.position.copy(point);
            ring.lookAt(new THREE.Vector3(0, 0, 0));
            ring.name = markerId + '_ring';
            
            currentDocScene.add(marker);
            currentDocScene.add(ring);
        }
        
        // Określ kolor markera na podstawie daty
        function getMarkerColorByDate(timestamp) {
            const photoDate = new Date(timestamp);
            const today = new Date();
            const daysDiff = Math.floor((today - photoDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff === 0) return 0x4CAF50; // Zielony - dzisiaj
            if (daysDiff <= 7) return 0x2196F3; // Niebieski - ostatni tydzień
            if (daysDiff <= 30) return 0xFF9800; // Pomarańczowy - ostatni miesiąc
            if (daysDiff <= 90) return 0x9C27B0; // Fioletowy - ostatnie 3 miesiące
            return 0x607D8B; // Szary - starsze
        }
        
        // Pokaż informacje o markerze
        function showMarkerInfo(photoData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 12px;
                max-width: 800px;
                max-height: 90vh;
                overflow-y: auto;
                overflow-x: hidden;
                position: relative;
                margin: 20px;
                width: 90vw;
                box-sizing: border-box;
            `;
            
            // Znajdź inne zdjęcia z tego samego regionu do porównania
            const sameRegionPhotos = historicalPhotos.filter(photo => 
                photo.head_region === photoData.region && photo.id !== photoData.photoId
            );
            
            let imageHtml = '';
            if (photoData.imageUrl) {
                imageHtml = `
                    <div style="margin-bottom: 15px; text-align: center;">
                        <img src="${photoData.imageUrl}" alt="Zdjęcie trychoskopowe" style="
                            max-width: 100%;
                            max-height: 300px;
                            border-radius: 8px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        ">
                    </div>
                `;
            }
            
            let comparisonHtml = '';
            if (sameRegionPhotos.length > 0) {
                comparisonHtml = `
                    <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                        <h4 style="color: #333; margin-bottom: 10px;">Inne zdjęcia z tego regionu:</h4>
                        <div style="display: flex; gap: 10px; overflow-x: auto; padding: 10px 0;">
                            ${sameRegionPhotos.slice(0, 3).map(photo => `
                                <div style="
                                    min-width: 120px;
                                    text-align: center;
                                    cursor: pointer;
                                    padding: 8px;
                                    border-radius: 6px;
                                    background: #f9f9f9;
                                " onclick="showPhotoComparison('${photoData.photoId}', '${photo.id}')">
                                    ${photo.photo_url ? `<img src="${photo.photo_url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px;">` : '<div style="width: 100px; height: 100px; background: #ddd; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px;">Brak zdjęcia</div>'}
                                    <div style="font-size: 11px; color: #666; margin-top: 5px;">${new Date(photo.created_at).toLocaleDateString('pl-PL')}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${sameRegionPhotos.length > 3 ? `<p style="text-align: center; color: #666; font-size: 12px;">I ${sameRegionPhotos.length - 3} więcej...</p>` : ''}
                    </div>
                `;
            }
            
            content.innerHTML = `
                <button style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;" onclick="this.closest('.modal').remove()">×</button>
                <h3 style="margin-top: 0; color: #333;">Zdjęcie trychoskopowe</h3>
                
                ${imageHtml}
                
                <div style="margin-bottom: 15px;">
                    <strong>Region:</strong> ${photoData.region}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Data:</strong> ${photoData.timestamp}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Notatki:</strong> ${photoData.notes || 'Brak notatek'}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>ID zdjęcia:</strong> ${photoData.photoId}
                </div>
                
                ${comparisonHtml}
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.closest('.modal').remove()" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        margin-right: 10px;
                    ">Zamknij</button>
                    ${sameRegionPhotos.length > 0 ? `
                        <button onclick="showRegionHistory('${photoData.region}')" style="
                            background: #2196F3;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            cursor: pointer;
                        ">Historia regionu</button>
                    ` : ''}
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // Zamknij na kliknięcie w tło
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Pokaż porównanie dwóch zdjęć
        function showPhotoComparison(photoId1, photoId2) {
            console.log('=== DEBUG SHOWPHOTOCOMPARISON ===');
            console.log('photoId1:', photoId1);
            console.log('photoId2:', photoId2);
            
            // Zamknij poprzedni modal
            const existingModal = document.querySelector('.modal');
            if (existingModal) existingModal.remove();
            
            // Szukaj w historycznych i przechwyconych zdjęciach - rozszerzony algorytm
            let photo1 = historicalPhotos.find(p => 
                p.id == photoId1 || 
                p.photo_url == photoId1 || 
                p.image == photoId1 || 
                p.url == photoId1 ||
                (p.photo_url && p.photo_url.includes(photoId1)) ||
                (p.image && p.image.includes(photoId1)) ||
                (p.url && p.url.includes(photoId1))
            );
            
            let photo2 = historicalPhotos.find(p => 
                p.id == photoId2 || 
                p.photo_url == photoId2 || 
                p.image == photoId2 || 
                p.url == photoId2 ||
                (p.photo_url && p.photo_url.includes(photoId2)) ||
                (p.image && p.image.includes(photoId2)) ||
                (p.url && p.url.includes(photoId2))
            );
            
            console.log('Znaleziono photo1 w historycznych:', photo1);
            console.log('Znaleziono photo2 w historycznych:', photo2);
            
            if (!photo1) {
                photo1 = capturedPhotos.find(p => 
                    p.id == photoId1 || 
                    p.photo_url == photoId1 || 
                    p.image == photoId1 || 
                    p.url == photoId1 ||
                    (p.photo_url && p.photo_url.includes(photoId1)) ||
                    (p.image && p.image.includes(photoId1)) ||
                    (p.url && p.url.includes(photoId1))
                );
                console.log('Znaleziono photo1 w przechwyconych:', photo1);
            }
            
            if (!photo2) {
                photo2 = capturedPhotos.find(p => 
                    p.id == photoId2 || 
                    p.photo_url == photoId2 || 
                    p.image == photoId2 || 
                    p.url == photoId2 ||
                    (p.photo_url && p.photo_url.includes(photoId2)) ||
                    (p.image && p.image.includes(photoId2)) ||
                    (p.url && p.url.includes(photoId2))
                );
                console.log('Znaleziono photo2 w przechwyconych:', photo2);
            }
            
            if (!photo1 || !photo2) {
                console.error('Nie znaleziono zdjęć do porównania');
                console.error('photo1:', photo1);
                console.error('photo2:', photo2);
                console.error('Dostępne historyczne zdjęcia:', historicalPhotos);
                console.error('Dostępne przechwycone zdjęcia:', capturedPhotos);
                showNotification('Nie znaleziono zdjęć do porównania', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 12px;
                max-width: 95vw;
                max-height: 90vh;
                overflow-y: auto;
                overflow-x: hidden;
                position: relative;
                margin: 20px;
                width: 90vw;
                box-sizing: border-box;
            `;
            
            content.innerHTML = `
                <button style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;" onclick="this.closest('.modal').remove()">×</button>
                <h3 style="margin-top: 0; color: #333; text-align: center;">Porównanie zdjęć</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">${(photo1.head_region || photo1.region?.name || photo1.region || 'Nieznany region')} vs ${(photo2.head_region || photo2.region?.name || photo2.region || 'Nieznany region')}</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div style="text-align: center;">
                        <h4 style="color: #666; margin-bottom: 5px;">${new Date(photo1.created_at || photo1.timestamp || new Date()).toLocaleDateString('pl-PL')}</h4>
                        <h5 style="color: #4CAF50; margin-bottom: 10px; font-weight: normal;">${photo1.head_region || photo1.region?.name || photo1.region || 'Nieznany region'}</h5>
                        ${(photo1.photo_url || photo1.image || photo1.url) ? `<img src="${photo1.photo_url || photo1.image || photo1.url}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">` : '<div style="width: 100%; height: 300px; background: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">Brak zdjęcia</div>'}
                        <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; text-align: left;">
                            <strong>Notatki:</strong> ${photo1.note || photo1.notes || 'Brak notatek'}
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <h4 style="color: #666; margin-bottom: 5px;">${new Date(photo2.created_at || photo2.timestamp || new Date()).toLocaleDateString('pl-PL')}</h4>
                        <h5 style="color: #4CAF50; margin-bottom: 10px; font-weight: normal;">${photo2.head_region || photo2.region?.name || photo2.region || 'Nieznany region'}</h5>
                        ${(photo2.photo_url || photo2.image || photo2.url) ? `<img src="${photo2.photo_url || photo2.image || photo2.url}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">` : '<div style="width: 100%; height: 300px; background: #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center;">Brak zdjęcia</div>'}
                        <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; text-align: left;">
                            <strong>Notatki:</strong> ${photo2.note || photo2.notes || 'Brak notatek'}
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.closest('.modal').remove()" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                    ">Zamknij</button>
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Pokaż historię całego regionu
        function showRegionHistory(regionName) {
            // Zamknij poprzedni modal
            const existingModal = document.querySelector('.modal');
            if (existingModal) existingModal.remove();
            
            const regionPhotos = historicalPhotos.filter(photo => 
                photo.region && photo.region.name === regionName
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            if (regionPhotos.length === 0) {
                showNotification('Brak zdjęć dla tego regionu', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 20px;
                border-radius: 12px;
                max-width: 95vw;
                max-height: 90vh;
                overflow-y: auto;
                overflow-x: hidden;
                position: relative;
                margin: 20px;
                width: 90vw;
                box-sizing: border-box;
            `;
            
            content.innerHTML = `
                <button style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;" onclick="this.closest('.modal').remove()">×</button>
                <h3 style="margin-top: 0; color: #333; text-align: center;">Historia regionu: ${regionName}</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Znaleziono ${regionPhotos.length} zdjęć</p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    ${regionPhotos.map(photo => `
                        <div style="
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 15px;
                            background: #f9f9f9;
                            text-align: center;
                        ">
                            <h5 style="margin-top: 0; color: #333;">${new Date(photo.timestamp).toLocaleDateString('pl-PL')}</h5>
                            ${photo.url ? `<img src="${photo.url}" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">` : '<div style="width: 100%; height: 150px; background: #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">Brak zdjęcia</div>'}
                            <div style="text-align: left; font-size: 14px; color: #666;">
                                <strong>Notatki:</strong> ${photo.notes || 'Brak notatek'}
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.closest('.modal').remove()" style="
                        background: #4CAF50;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                    ">Zamknij</button>
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function getRegionName(point) {
            // Poprawiona logika z lepszym podziałem na regiony
            const x = point.x;
            const y = point.y;
            const z = point.z;
            
            console.log('Punkt kliknięty:', { x, y, z }); // Debug log
            
            // Najpierw sprawdź wysokość (Y)
            let heightLevel = '';
            if (y > 0.4) {
                heightLevel = 'górna';
            } else if (y > -0.1) {
                heightLevel = 'środkowa';
            } else {
                heightLevel = 'dolna';
            }
            
            // Sprawdź pozycję przód/tył (Z) - węższe progi
            let frontBack = '';
            if (z > 0.35) {
                frontBack = 'przód';  // Z dodatnie to PRZÓD
            } else if (z < -0.35) {
                frontBack = 'tył';    // Z ujemne to TYŁ
            } else {
                frontBack = 'środek';
            }
            
            // Sprawdź boki (X) - węższe progi dla lepszego podziału
            let leftRight = '';
            if (x > 0.25) {
                leftRight = 'lewa';   // X dodatnie to LEWA strona
            } else if (x < -0.25) {
                leftRight = 'prawa';  // X ujemne to PRAWA strona
            } else {
                leftRight = 'środek';
            }
            
            // CIEMIĘ - najwyższa część
            if (y > 0.7) {
                return 'Ciemię';
            }
            
            // CZOŁO - przód głowy z podziałem na strony
            if (frontBack === 'przód') {
                if (heightLevel === 'górna') {
                    // Zakola - tylko w rogach
                    if (leftRight === 'lewa' && x > 0.4) {
                        return 'Zakole lewe';
                    }
                    if (leftRight === 'prawa' && x < -0.4) {
                        return 'Zakole prawe';
                    }
                    // Czoło górne z podziałem na strony
                    if (leftRight === 'lewa') {
                        return 'Czoło górne lewe';
                    }
                    if (leftRight === 'prawa') {
                        return 'Czoło górne prawe';
                    }
                    return 'Czoło górne środek';
                } else if (heightLevel === 'środkowa') {
                    // Czoło środkowe z podziałem na strony
                    if (leftRight === 'lewa') {
                        return 'Czoło lewe';
                    }
                    if (leftRight === 'prawa') {
                        return 'Czoło prawe';
                    }
                    return 'Czoło środek';
                } else {
                    // Czoło dolne z podziałem na strony
                    if (leftRight === 'lewa') {
                        return 'Czoło dolne lewe';
                    }
                    if (leftRight === 'prawa') {
                        return 'Czoło dolne prawe';
                    }
                    return 'Czoło dolne środek';
                }
            }
            
            // TYŁ GŁOWY - tył z podziałem na strony
            if (frontBack === 'tył') {
                if (heightLevel === 'górna') {
                    if (leftRight === 'lewa') {
                        return 'Potylica górna lewa';
                    }
                    if (leftRight === 'prawa') {
                        return 'Potylica górna prawa';
                    }
                    return 'Potylica górna środek';
                } else if (heightLevel === 'środkowa') {
                    if (leftRight === 'lewa') {
                        return 'Potylica lewa';
                    }
                    if (leftRight === 'prawa') {
                        return 'Potylica prawa';
                    }
                    return 'Potylica środek';
                } else {
                    // Kark tylko dla bardzo niskich części tyłu głowy
                    if (y < -0.3) {
                        return 'Kark';
                    } else {
                        if (leftRight === 'lewa') {
                            return 'Potylica dolna lewa';
                        }
                        if (leftRight === 'prawa') {
                            return 'Potylica dolna prawa';
                        }
                        return 'Potylica dolna środek';
                    }
                }
            }
            
            // BOKI GŁOWY - lewa/prawa strona (środek Z)
            if (leftRight === 'lewa') {
                if (heightLevel === 'górna') return 'Lewa strona góra';
                if (heightLevel === 'środkowa') return 'Skroń lewa';
                return 'Lewa strona dół';
            }
            
            if (leftRight === 'prawa') {
                if (heightLevel === 'górna') return 'Prawa strona góra';
                if (heightLevel === 'środkowa') return 'Skroń prawa';
                return 'Prawa strona dół';
            }
            
            // ŚRODEK GŁOWY - domyślne (środek we wszystkich wymiarach)
            if (heightLevel === 'górna') return 'Góra głowy środek';
            if (heightLevel === 'środkowa') return 'Środek głowy';
            return 'Dolna część głowy';
        }
        
        // Funkcja pokazywania powiadomień
        function showNotification(message, type = 'info') {
            // Usuń poprzednie powiadomienia
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            // Kolory w zależności od typu
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#4CAF50';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#f44336';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ff9800';
                    break;
                default:
                    notification.style.backgroundColor = '#2196F3';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animacja wejścia
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Automatyczne usuwanie po 3 sekundach
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // Fullscreen
        function initializeFullscreen() {
            const goFullscreenBtn = document.getElementById('goFullscreen');
            const exitFullscreenBtn = document.getElementById('exitFullscreen');
            const fullscreenOverlay = document.getElementById('fullscreenOverlay');
            const fullscreenVideo = document.getElementById('fullscreenVideo');
            
            goFullscreenBtn?.addEventListener('click', () => {
                if (currentStream) {
                    fullscreenVideo.srcObject = currentStream;
                    fullscreenOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            });
            
            exitFullscreenBtn?.addEventListener('click', () => {
                fullscreenOverlay.classList.remove('active');
                document.body.style.overflow = 'auto';
            });
            
            // ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && fullscreenOverlay.classList.contains('active')) {
                    fullscreenOverlay.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        }
        
        // Robienie zdjęć
        document.getElementById('capturePhoto')?.addEventListener('click', async () => {
            console.log('*** ROZPOCZYNANIE ROBIENIA ZDJĘCIA ***');
            
            // Sprawdź selectedRegion
            console.log('selectedRegion:', selectedRegion);
            if (!selectedRegion) {
                console.log('BŁĄD: Nie wybrano regionu');
                alert('Najpierw wybierz obszar na modelu 3D');
                return;
            }
            
            // Sprawdź video
            const video = document.getElementById('cameraPreviewDoc');
            console.log('Video element:', video);
            console.log('Video srcObject:', video ? video.srcObject : 'brak video');
            
            if (!video || !video.srcObject) {
                console.log('BŁĄD: Kamera nie jest dostępna');
                alert('Kamera nie jest dostępna');
                return;
            }
            
            // Sprawdź rozmiary video
            console.log('Video rozmiary:', video.videoWidth, 'x', video.videoHeight);
            console.log('Video readyState:', video.readyState);
            
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                console.log('BŁĄD: Video ma rozmiary 0x0');
                alert('Video nie jest jeszcze gotowe. Spróbuj ponownie za chwilę.');
                return;
            }
            
            // Stwórz canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Ustaw rozmiary canvas na podstawie rzeczywistych rozmiarów video
            canvas.width = video.videoWidth || 1920;
            canvas.height = video.videoHeight || 1080;
            
            console.log('Canvas rozmiary:', canvas.width, 'x', canvas.height);
            
            // Narysuj obraz z video na canvas
            try {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                console.log('Obraz narysowany na canvas');
            } catch (error) {
                console.error('Błąd podczas rysowania na canvas:', error);
                alert('Nie udało się przechwycić obrazu');
                return;
            }
            
            // Sprawdź czy canvas ma dane
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasData = imageData.data.some(byte => byte !== 0);
            console.log('Canvas ma dane:', hasData);
            console.log('Pierwsze 10 bajtów imageData:', Array.from(imageData.data.slice(0, 10)));
            
            if (!hasData) {
                console.log('BŁĄD: Canvas nie ma danych');
                alert('Nie udało się przechwycić obrazu. Spróbuj ponownie.');
                return;
            }
            
            // Pobierz notatkę
            const note = document.getElementById('photoNote').value;
            console.log('Notatka:', note);
            
            // Sprawdź jakość capture
            checkCaptureQuality(canvas);
            
            // Stwórz blob z najwyższą jakością (0.95 zamiast 0.8)
            const blob = await new Promise((resolve, reject) => {
                canvas.toBlob((blob) => {
                    if (blob) {
                        console.log('Blob utworzony:', blob.size, 'bajtów');
                        console.log('Jakość JPEG: 95% (maksymalna dla zachowania detali)');
                        resolve(blob);
                    } else {
                        console.error('Nie udało się utworzyć blob');
                        reject(new Error('Nie udało się utworzyć blob'));
                    }
                }, 'image/jpeg', 0.95);  // Zwiększona jakość z 0.8 do 0.95
            });
            
            if (!blob || blob.size === 0) {
                console.log('BŁĄD: Blob jest pusty lub null');
                alert('Nie udało się przechwycić obrazu');
                return;
            }
            
            // Zapisz zdjęcie na serwerze
            try {
                const pesel = window.location.pathname.split('/').pop();
                console.log('PESEL z URL:', pesel);
                
                // Przygotuj FormData
                const formData = new FormData();
                formData.append('photo', blob, 'trichoscopy.jpg');
                formData.append('note', note);
                formData.append('head_region', selectedRegion.name);
                
                console.log('FormData przygotowane:');
                console.log('- photo blob size:', blob.size);
                console.log('- note:', note);
                console.log('- head_region:', selectedRegion.name);
                
                // Wyślij na serwer
                const saveResponse = await fetch(`/api/save-trichoscopy-photo/${pesel}`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Odpowiedź serwera status:', saveResponse.status);
                
                const result = await saveResponse.json();
                console.log('Odpowiedź serwera:', result);
                
                if (result.success) {
                    console.log('Zdjęcie zapisane pomyślnie');
                    
                    // Dodaj trwały marker trychoskopii na modelu 3D
                    const markerPoint = new THREE.Vector3(selectedRegion.x, selectedRegion.y, selectedRegion.z);
                    addTrichoscopyMarker(markerPoint, {
                        photoId: result.photo_id || Date.now(),
                        timestamp: new Date().toLocaleString('pl-PL'),
                        notes: note,
                        region: selectedRegion.name,
                        filename: `photo_${result.photo_id || Date.now()}.jpg`
                    });
                    
                    // Usuń tymczasowy marker
                    const tempMarker = currentDocScene?.getObjectByName('tempMarker');
                    if (tempMarker) {
                        currentDocScene.remove(tempMarker);
                    }
                    
                    // Wyczyść notatkę i resetuj wybór regionu
                    document.getElementById('photoNote').value = '';
                    selectedRegion = null;
                    document.getElementById('selectedRegionName').textContent = 'Nie wybrano';
                    
                    // Odśwież galerię z serwera
                    await loadHistoricalPhotos();
                    renderGallery();
                    
                    // Pokaż komunikat sukcesu
                    showNotification('Zdjęcie zostało zapisane na serwerze!', 'success');
                } else {
                    console.error('Błąd zapisywania zdjęcia:', result.error);
                    alert('Błąd podczas zapisywania zdjęcia: ' + result.error);
                }
            } catch (error) {
                console.error('Błąd podczas wysyłania zdjęcia:', error);
                alert('Nie udało się zapisać zdjęcia na serwerze');
            }
        });

        // Funkcja inicjalizująca kontrolki kamery
        function initializeCameraControls() {
            console.log('Inicjalizacja kontrolek kamery...');
            
            // Przełączanie kamery
            const switchCameraBtn = document.getElementById('switchCamera');
            if (switchCameraBtn) {
                console.log('Przycisk "Zmień kamerę" znaleziony');
                
                // Usuń poprzednie event listenery
                switchCameraBtn.replaceWith(switchCameraBtn.cloneNode(true));
                const newSwitchBtn = document.getElementById('switchCamera');
                
                newSwitchBtn.addEventListener('click', async () => {
                    console.log('Kliknięto przycisk "Zmień kamerę"');
                    try {
                        // Pobierz listę dostępnych kamer
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        availableCameras = devices.filter(device => device.kind === 'videoinput');
                        
                        console.log('Dostępne kamery do przełączenia:', availableCameras.length);
                        
                        if (availableCameras.length <= 1) {
                            alert('Dostępna jest tylko jedna kamera');
                            return;
                        }
                        
                        // Przełącz na następną kamerę
                        currentCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
                        
                        console.log('Przełączanie na kamerę o indeksie:', currentCameraIndex);
                        
                        // Zatrzymaj obecny strumień
                        if (currentStream) {
                            currentStream.getTracks().forEach(track => track.stop());
                        }
                        
                        // Uruchom nową kamerę z wysoką jakością
                        const constraints = {
                            video: {
                                deviceId: availableCameras[currentCameraIndex].deviceId ? 
                                    { exact: availableCameras[currentCameraIndex].deviceId } : undefined,
                                // Maxymalna jakość dla iPhone i innych urządzeń
                                width: { 
                                    min: 1280,
                                    ideal: 4096,  // 4K dla iPhone Pro
                                    max: 4096 
                                },
                                height: { 
                                    min: 720,
                                    ideal: 2160,  // 4K dla iPhone Pro
                                    max: 2160 
                                },
                                // Dodatkowe ustawienia dla najlepszej jakości
                                frameRate: { ideal: 30, max: 60 },
                                // Ustawienia specifyczne dla iPhone i wysokiej jakości
                                aspectRatio: { ideal: 16/9 },
                                resizeMode: 'none',  // Nie zmieniaj rozmiaru
                                // Dodatkowe constraints dla lepszej jakości
                                whiteBalanceMode: 'auto',
                                exposureMode: 'auto',
                                focusMode: 'auto'
                            }
                        };
                        
                        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                        
                        const videoElement = currentMode === 'presentation' 
                            ? document.getElementById('cameraPreview')
                            : document.getElementById('cameraPreviewDoc');
                        
                        if (videoElement) {
                            videoElement.srcObject = currentStream;
                            // Resetuj zoom video po przełączeniu kamery
                            videoElement.style.transform = 'scale(1)';
                            videoElement.style.transformOrigin = 'center center';
                            // Resetuj zmienne zoom
                            presentationZoom = 1;
                            documentationZoom = 1;
                            console.log('Kamera przełączona pomyślnie');
                        }
                        
                        const cameraLabel = availableCameras[currentCameraIndex].label || 'Nieznana kamera';
                        console.log('Przełączono na kamerę:', cameraLabel);
                        showNotification(`Przełączono na: ${cameraLabel}`, 'success');
                        
                    } catch (error) {
                        console.error('Błąd przełączania kamery:', error);
                        alert('Nie można przełączyć kamery: ' + error.message);
                    }
                });
            } else {
                console.error('Nie znaleziono przycisku "Zmień kamerę"');
            }

            // Robienie zdjęć
            const captureBtn = document.getElementById('capturePhoto');
            if (captureBtn) {
                console.log('Przycisk "Zrób zdjęcie" znaleziony');
            } else {
                console.error('Nie znaleziono przycisku "Zrób zdjęcie"');
            }
        }
        
        // Inicjalizuj kontrolki kamery po załadowaniu DOM
        initializeCameraControls();
        
        function displayPhoto(photo) {
            const container = document.getElementById('photoGallery');
            if (!container) {
                console.error('Kontener photoGallery nie został znaleziony');
                return;
            }
            
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-item';
            photoDiv.innerHTML = `
                <img src="${photo.image || photo.photo_url}" alt="Zdjęcie trychoskopowe">
                <div class="photo-info">
                    <h5>${photo.region?.name || photo.head_region || 'Nieznany region'}</h5>
                    <p>${photo.timestamp || photo.created_at}</p>
                    <p>${photo.note || ''}</p>
                </div>
            `;
            container.appendChild(photoDiv);
        }
        
        // Zoom controls
        document.getElementById('zoomInBtn')?.addEventListener('click', () => {
            presentationZoom = Math.min(presentationZoom + 0.2, 3);
            applyZoom();
        });
        
        document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
            presentationZoom = Math.max(presentationZoom - 0.2, 1);
            applyZoom();
        });
        
        function applyZoom() {
            // Znajdź aktywny tryb
            const presentationMode = document.querySelector('.presentation-mode.active');
            const documentationMode = document.querySelector('.documentation-mode.active');
            
            let targetVideo = null;
            let zoomValue = 1;
            
            if (presentationMode) {
                // W trybie prezentacji
                targetVideo = document.getElementById('cameraPreview');
                zoomValue = presentationZoom;
            } else if (documentationMode) {
                // W trybie dokumentacji
                targetVideo = document.getElementById('cameraPreviewDoc');
                zoomValue = documentationZoom;
            }
            
            // Aplikuj zoom tylko do odpowiedniego video
            if (targetVideo) {
                targetVideo.style.transform = `scale(${zoomValue})`;
                targetVideo.style.transformOrigin = 'center center';
            }
        }
        
        // Grid toggle - TRYB PREZENTACJI
        document.getElementById('toggleGrid')?.addEventListener('click', (e) => {
            togglePresentationGrid();
        });
        
        // Funkcja dla siatki w trybie prezentacji
        function togglePresentationGrid() {
            const video = document.getElementById('cameraPreview');
            if (!video) return;
            
            const existingGrid = video.parentElement.querySelector('.camera-grid');
            
            if (existingGrid) {
                existingGrid.remove();
            } else {
                const grid = document.createElement('div');
                grid.className = 'camera-grid';
                grid.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 5;
                `;
                
                // Dodaj linie siatki
                for (let i = 1; i <= 2; i++) {
                    const vLine = document.createElement('div');
                    vLine.style.cssText = `
                        position: absolute;
                        left: ${i * 33.33}%;
                        top: 0;
                        width: 1px;
                        height: 100%;
                        background: rgba(255,255,255,0.7);
                        box-shadow: 0 0 2px rgba(0,0,0,0.3);
                    `;
                    grid.appendChild(vLine);
                    
                    const hLine = document.createElement('div');
                    hLine.style.cssText = `
                        position: absolute;
                        top: ${i * 33.33}%;
                        left: 0;
                        width: 100%;
                        height: 1px;
                        background: rgba(255,255,255,0.7);
                        box-shadow: 0 0 2px rgba(0,0,0,0.3);
                    `;
                    grid.appendChild(hLine);
                }
                
                video.parentElement.appendChild(grid);
            }
        }
        
        // Funkcja dla siatki w trybie pełnoekranowym
        function toggleFullscreenGrid() {
            const video = document.getElementById('fullscreenVideo');
            if (!video) return;
            
            const existingGrid = video.parentElement.querySelector('.fullscreen-grid');
            
            if (existingGrid) {
                existingGrid.remove();
            } else {
                const grid = document.createElement('div');
                grid.className = 'fullscreen-grid';
                grid.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 5;
                `;
                
                // Dodaj linie siatki
                for (let i = 1; i <= 2; i++) {
                    const vLine = document.createElement('div');
                    vLine.style.cssText = `
                        position: absolute;
                        left: ${i * 33.33}%;
                        top: 0;
                        width: 2px;
                        height: 100%;
                        background: rgba(255,255,255,0.8);
                        box-shadow: 0 0 3px rgba(0,0,0,0.5);
                    `;
                    grid.appendChild(vLine);
                    
                    const hLine = document.createElement('div');
                    hLine.style.cssText = `
                        position: absolute;
                        top: ${i * 33.33}%;
                        left: 0;
                        width: 100%;
                        height: 2px;
                        background: rgba(255,255,255,0.8);
                        box-shadow: 0 0 3px rgba(0,0,0,0.5);
                    `;
                    grid.appendChild(hLine);
                }
                
                video.parentElement.appendChild(grid);
            }
        }
        
        // Event listenery dla pełnoekranowego trybu
        document.getElementById('fullscreenToggleGrid')?.addEventListener('click', () => {
            toggleFullscreenGrid();
        });
        
        document.getElementById('fullscreenZoomIn')?.addEventListener('click', () => {
            currentZoom = Math.min(currentZoom + 0.3, 5);
            applyFullscreenZoom();
        });
        
        document.getElementById('fullscreenZoomOut')?.addEventListener('click', () => {
            currentZoom = Math.max(currentZoom - 0.3, 1);
            applyFullscreenZoom();
        });
        
        document.getElementById('exitFullscreen')?.addEventListener('click', () => {
            const overlay = document.getElementById('fullscreenOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = 'auto';
                // Resetuj zoom
                currentZoom = 1;
                applyFullscreenZoom();
            }
        });
        
        // Funkcja zoom dla pełnoekranowego trybu
        function applyFullscreenZoom() {
            const video = document.getElementById('fullscreenVideo');
            if (video) {
                video.style.transform = `scale(${currentZoom})`;
                video.style.transformOrigin = 'center center';
            }
        }
        
        // Cleanup przy zamknięciu strony
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });
        
        // ===== FUNKCJONALNOŚĆ GALERII =====
        
        // Inicjalizacja galerii
        function initializeGallery() {
            console.log('Inicjalizacja galerii...');
            
            // Sprawdź kontener z przyciskami
            const photoControls = document.querySelector('.photo-controls');
            console.log('Kontener photo-controls:', photoControls);
            if (photoControls) {
                console.log('Kontener photo-controls style:', {
                    display: window.getComputedStyle(photoControls).display,
                    visibility: window.getComputedStyle(photoControls).visibility,
                    zIndex: window.getComputedStyle(photoControls).zIndex
                });
            }
            
            // Sprawdź wszystkie przyciski w kontenerze
            const allButtons = document.querySelectorAll('.photo-btn');
            console.log('Wszystkie przyciski photo-btn:', allButtons.length);
            allButtons.forEach((btn, index) => {
                console.log(`Przycisk ${index}:`, btn.id, btn.textContent.trim());
            });
            
            // Przełączanie widoku galerii
            const viewButtons = document.querySelectorAll('.view-btn');
            viewButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.dataset.view;
                    
                    // Aktualizuj przyciski
                    viewButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Zmień widok galerii
                    const gallery = document.getElementById('photoGallery');
                    gallery.className = `photo-gallery ${view}-view`;
                    
                    // Przerenderuj zdjęcia
                    renderGallery();
                });
            });
            
            // Sortowanie
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                sortSelect.addEventListener('change', () => {
                    renderGallery();
                });
                console.log('Event listener dodany do sortBy');
            } else {
                console.error('Element sortBy nie został znaleziony!');
            }
            
            // Filtrowanie
            const filterSelect = document.getElementById('photoFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', () => {
                    currentPhotoFilter = filterSelect.value;
                    renderGallery();
                });
                console.log('Event listener dodany do photoFilter');
            } else {
                console.error('Element photoFilter nie został znaleziony!');
            }
            
            // Kontrolki kamery dokumentacji
            document.getElementById('zoomInDocBtn')?.addEventListener('click', () => {
                documentationZoom = Math.min(documentationZoom + 0.2, 3);
                applyZoom();
            });
            
            document.getElementById('zoomOutDocBtn')?.addEventListener('click', () => {
                documentationZoom = Math.max(documentationZoom - 0.2, 1);
                applyZoom();
            });
            
            document.getElementById('toggleGridDoc')?.addEventListener('click', () => {
                toggleCameraGrid();
            });
            
            const goFullscreenDocBtn = document.getElementById('goFullscreenDoc');
            if (goFullscreenDocBtn) {
                console.log('Przycisk goFullscreenDoc znaleziony, dodaję event listener');
                console.log('Przycisk style:', {
                    display: window.getComputedStyle(goFullscreenDocBtn).display,
                    visibility: window.getComputedStyle(goFullscreenDocBtn).visibility,
                    zIndex: window.getComputedStyle(goFullscreenDocBtn).zIndex,
                    position: window.getComputedStyle(goFullscreenDocBtn).position
                });
                
                goFullscreenDocBtn.addEventListener('click', (e) => {
                    console.log('*** KLIKNIĘTO PRZYCISK PEŁNY EKRAN ***');
                    console.log('Event:', e);
                    
                    const video = document.getElementById('cameraPreviewDoc');
                    console.log('Video element:', video);
                    console.log('Video srcObject:', video ? video.srcObject : 'brak video');
                    
                    if (video && video.srcObject) {
                        console.log('Przechodzenie do pełnego ekranu z dokumentacji');
                        const fullscreenVideo = document.getElementById('fullscreenVideo');
                        const fullscreenOverlay = document.getElementById('fullscreenOverlay');
                        
                        console.log('Fullscreen video:', fullscreenVideo);
                        console.log('Fullscreen overlay:', fullscreenOverlay);
                        
                        if (fullscreenVideo && fullscreenOverlay) {
                            fullscreenVideo.srcObject = video.srcObject;
                            fullscreenOverlay.classList.add('active');
                            document.body.style.overflow = 'hidden';
                            console.log('Pełny ekran aktywowany');
                            
                            // Upewnij się, że overflow zostanie przywrócony
                            const restoreOverflow = () => {
                                if (!fullscreenOverlay.classList.contains('active')) {
                                    document.body.style.overflow = 'auto';
                                }
                            };
                            
                            // Obserwuj zmiany w klasie active
                            const observer = new MutationObserver(restoreOverflow);
                            observer.observe(fullscreenOverlay, { attributes: true, attributeFilter: ['class'] });
                        } else {
                            console.error('Brak elementów pełnoekranowych');
                        }
                    } else {
                        console.error('Video element lub strumień kamery nie jest dostępny');
                        console.error('Video element istnieje:', !!video);
                        console.error('Video srcObject istnieje:', !!(video && video.srcObject));
                        alert('Kamera nie jest dostępna');
                    }
                });
                
                // Dodaj dodatkowy test - sprawdź czy przycisk jest kliknięty
                setTimeout(() => {
                    console.log('Test po 2 sekundach - czy przycisk jest dostępny?');
                    console.log('Przycisk znaleziony:', !!document.getElementById('goFullscreenDoc'));
                    console.log('Przycisk aktywny:', document.getElementById('goFullscreenDoc') === document.activeElement);
                }, 2000);
                
            } else {
                console.error('Przycisk goFullscreenDoc nie został znaleziony w DOM');
            }
        }
        
        // Renderowanie galerii
        function renderGallery() {
            console.log('=== RENDER GALLERY ===');
            const gallery = document.getElementById('photoGallery');
            
            if (!gallery) {
                console.error('Element galerii (photoGallery) nie został znaleziony!');
                return;
            }
            
            console.log('Galeria znaleziona:', gallery);
            
            const sortBy = document.getElementById('sortBy')?.value || 'newest';
            const currentViewBtn = document.querySelector('.view-btn.active');
            const currentView = currentViewBtn ? currentViewBtn.dataset.view : 'grid';
            
            // Połącz zdjęcia z sesji i historyczne
            let allPhotos = [...capturedPhotos, ...historicalPhotos];
            
            // Filtruj według daty
            if (currentPhotoFilter !== 'all') {
                allPhotos = filterPhotosByDate(allPhotos, currentPhotoFilter);
            }
            
            // Sortuj
            allPhotos = sortPhotos(allPhotos, sortBy);
            
            // Wyczyść galerię
            gallery.innerHTML = '';
            
            if (allPhotos.length === 0) {
                gallery.innerHTML = '<div class="no-photos">Brak zdjęć do wyświetlenia</div>';
                return;
            }
            
            // Renderuj zdjęcia
            console.log('Renderowanie zdjęć, liczba:', allPhotos.length);
            allPhotos.forEach((photo, index) => {
                console.log(`Tworzenie elementu zdjęcia ${index + 1}:`, photo);
                const photoElement = createPhotoElement(photo, currentView);
                gallery.appendChild(photoElement);
                console.log(`Element zdjęcia ${index + 1} dodany do galerii`);
            });
            
            console.log('Galeria renderowana pomyślnie, zdjęć:', allPhotos.length);
            
            // Zaktualizuj interfejs porównania po renderowaniu galerii
            setTimeout(() => {
                updateComparisonUI();
            }, 100);
        }
        
        // Filtrowanie zdjęć według daty
        function filterPhotosByDate(photos, filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return photos.filter(photo => {
                const photoDate = new Date(photo.created_at || photo.timestamp);
                const photoDayStart = new Date(photoDate.getFullYear(), photoDate.getMonth(), photoDate.getDate());
                
                switch (filter) {
                    case 'today':
                        return photoDayStart.getTime() === today.getTime();
                    case 'week':
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        return photoDayStart >= weekAgo;
                    case 'month':
                        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        return photoDayStart >= monthAgo;
                    case '3months':
                        const threeMonthsAgo = new Date(today.getTime() - 90 * 24 * 60 * 60 * 1000);
                        return photoDayStart >= threeMonthsAgo;
                    default:
                        return true;
                }
            });
        }
        
        // Sortowanie zdjęć
        function sortPhotos(photos, sortBy) {
            return [...photos].sort((a, b) => {
                switch (sortBy) {
                    case 'newest':
                        return new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp);
                    case 'oldest':
                        return new Date(a.created_at || a.timestamp) - new Date(b.created_at || b.timestamp);
                    case 'region':
                        const regionA = a.head_region || a.region?.name || a.region || 'Nieznany';
                        const regionB = b.head_region || b.region?.name || b.region || 'Nieznany';
                        return regionA.localeCompare(regionB);
                    default:
                        return 0;
                }
            });
        }
        
        // Tworzenie elementu zdjęcia
        function createPhotoElement(photo, view) {
            const div = document.createElement('div');
            div.className = `gallery-photo ${view}-view`;
            
            const imageUrl = photo.photo_url || photo.image || photo.url || '';
            const region = photo.head_region || photo.region?.name || photo.region || 'Nieznany region';
            const timestamp = new Date(photo.created_at || photo.timestamp).toLocaleString('pl-PL');
            const notes = photo.note || photo.notes || '';
            
            if (view === 'grid') {
                div.innerHTML = `
                    <img src="${imageUrl}" alt="Zdjęcie trychoskopowe" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSA2NUw0NSA1NUw2NSA3NUg3NVYyNUgyNVY3NUgzNVY2NVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+Cg=='">
                `;
            } else {
                div.innerHTML = `
                    <img src="${imageUrl}" alt="Zdjęcie trychoskopowe" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0zNSA2NUw0NSA1NUw2NSA3NUg3NVYyNUgyNVY3NUgzNVY2NVoiIGZpbGw9IiNEREREREQiLz4KPC9zdmc+Cg=='">
                `;
            }
            
            // Dodaj event listener do kliknięcia
            div.addEventListener('click', (e) => {
                console.log('=== KLIKNIĘCIE NA ZDJĘCIE ===');
                console.log('Photo data:', photo);
                console.log('Event:', e);
                
                // Użyj edytora zdjęć zamiast podglądu
                showFullscreenPhotoModal(photo);
            });
            
            return div;
        }
        
        // Podgląd zdjęcia
        function showPhotoPreview(photo) {
            console.log('=== SHOW PHOTO PREVIEW ===');
            console.log('Photo data:', photo);
            
            const preview = document.getElementById('photoPreview');
            const previewImage = document.getElementById('previewImage');
            const previewRegion = document.querySelector('.preview-region');
            const previewDate = document.querySelector('.preview-date');
            const previewNotes = document.querySelector('.preview-notes');
            
            console.log('Preview element:', preview);
            console.log('Preview image element:', previewImage);
            console.log('Preview region element:', previewRegion);
            console.log('Preview date element:', previewDate);
            console.log('Preview notes element:', previewNotes);
            
            if (!preview || !previewImage || !previewRegion || !previewDate || !previewNotes) {
                console.error('Brak wymaganych elementów podglądu!');
                // Fallback - użyj modalu z edytorem
                showFullscreenPhotoModal(photo);
                return;
            }
            
            const imageUrl = photo.photo_url || photo.image || photo.url || '';
            const region = photo.head_region || photo.region?.name || photo.region || 'Nieznany region';
            const timestamp = new Date(photo.created_at || photo.timestamp).toLocaleString('pl-PL');
            const notes = photo.note || photo.notes || 'Brak notatek';
            
            console.log('Image URL:', imageUrl);
            console.log('Region:', region);
            console.log('Timestamp:', timestamp);
            console.log('Notes:', notes);
            
            previewImage.src = imageUrl;
            previewRegion.textContent = region;
            previewDate.textContent = timestamp;
            previewNotes.textContent = notes;
            
            preview.style.display = 'block';
            
            // Przewiń do podglądu
            preview.scrollIntoView({ behavior: 'smooth' });
            
            console.log('Podgląd zdjęcia wyświetlony pomyślnie');
        }
        
        // Zamknij podgląd zdjęcia
        function closePhotoPreview() {
            document.getElementById('photoPreview').style.display = 'none';
        }
        
        // Wybierz do porównania
        function selectForComparison() {
            const previewImage = document.getElementById('previewImage');
            const currentPhotoUrl = previewImage.src;
            
            console.log('=== DEBUG PORÓWNYWANIA ===');
            console.log('URL zdjęcia:', currentPhotoUrl);
            console.log('Liczba historycznych zdjęć:', historicalPhotos.length);
            console.log('Liczba przechwyconych zdjęć:', capturedPhotos.length);
            console.log('Historyczne zdjęcia:', historicalPhotos);
            console.log('Przechwycone zdjęcia:', capturedPhotos);
            
            // Znajdź zdjęcie w historycznych lub przechwyconych
            let currentPhoto = historicalPhotos.find(p => 
                (p.photo_url || p.image || p.url) === currentPhotoUrl
            );
            
            console.log('Znaleziono w historycznych:', currentPhoto);
            
            if (!currentPhoto) {
                currentPhoto = capturedPhotos.find(p => 
                    (p.photo_url || p.image || p.url) === currentPhotoUrl
                );
                console.log('Znaleziono w przechwyconych:', currentPhoto);
            }
            
            if (!currentPhoto) {
                console.error('Nie znaleziono zdjęcia do porównania!');
                console.log('Próbuję alternatywne wyszukiwanie...');
                
                // Alternatywne wyszukiwanie po końcówce URL
                const photoFileName = currentPhotoUrl.split('/').pop();
                console.log('Nazwa pliku:', photoFileName);
                
                currentPhoto = historicalPhotos.find(p => {
                    const photoUrl = p.photo_url || p.image || p.url || '';
                    return photoUrl.includes(photoFileName);
                });
                
                if (!currentPhoto) {
                    currentPhoto = capturedPhotos.find(p => {
                        const photoUrl = p.photo_url || p.image || p.url || '';
                        return photoUrl.includes(photoFileName);
                    });
                }
                
                console.log('Znaleziono alternatywnie:', currentPhoto);
                
                if (!currentPhoto) {
                    showNotification('Nie można znaleźć zdjęcia do porównania', 'error');
                    return;
                }
            }
            
            // Sprawdź czy zdjęcie już nie jest wybrane
            const isAlreadySelected = selectedPhotosForComparison.some(p => 
                (p.id || p.photo_url) === (currentPhoto.id || currentPhoto.photo_url)
            );
            
            if (isAlreadySelected) {
                // Usuń z wyboru
                selectedPhotosForComparison = selectedPhotosForComparison.filter(p => 
                    (p.id || p.photo_url) !== (currentPhoto.id || currentPhoto.photo_url)
                );
                showNotification('Zdjęcie usunięte z porównania', 'info');
                updateComparisonUI();
                return;
            }
            
            // Dodaj do wyboru
            if (selectedPhotosForComparison.length >= 2) {
                showNotification('Możesz wybrać maksymalnie 2 zdjęcia do porównania', 'warning');
                return;
            }
            
            selectedPhotosForComparison.push(currentPhoto);
            showNotification(`Zdjęcie ${selectedPhotosForComparison.length}/2 wybrane do porównania`, 'success');
            
            // Jeśli wybrano 2 zdjęcia, uruchom porównanie
            if (selectedPhotosForComparison.length === 2) {
                setTimeout(() => {
                    startPhotoComparison();
                }, 1000);
            }
            
            updateComparisonUI();
        }
        
        // Uruchom porównanie dwóch wybranych zdjęć
        function startPhotoComparison() {
            if (selectedPhotosForComparison.length !== 2) {
                showNotification('Wybierz dokładnie 2 zdjęcia do porównania', 'warning');
                return;
            }
            
            const photo1 = selectedPhotosForComparison[0];
            const photo2 = selectedPhotosForComparison[1];
            
            // Użyj ID lub URL jako identyfikator
            const id1 = photo1.id || photo1.photo_url || photo1.url;
            const id2 = photo2.id || photo2.photo_url || photo2.url;
            
            showPhotoComparison(id1, id2);
            
            // Wyczyść wybór po porównaniu
            selectedPhotosForComparison = [];
            updateComparisonUI();
            // Odśwież pełną galerię jeśli jest otwarta
            if (document.getElementById('fullscreenGalleryOverlay').classList.contains('active')) {
                renderFullscreenGallery();
            }
        }
        
        // Zaktualizuj interfejs porównania
        function updateComparisonUI() {
            // Zaktualizuj tekst przycisku porównania w podglądzie
            const compareButton = document.querySelector('.btn-compare');
            if (compareButton) {
                if (selectedPhotosForComparison.length === 0) {
                    compareButton.innerHTML = '<i class="fas fa-balance-scale"></i> Porównaj';
                    compareButton.style.background = '#2196F3';
                } else if (selectedPhotosForComparison.length === 1) {
                    compareButton.innerHTML = '<i class="fas fa-balance-scale"></i> Wybierz drugie (1/2)';
                    compareButton.style.background = '#ff9800';
                } else {
                    compareButton.innerHTML = '<i class="fas fa-balance-scale"></i> Uruchom porównanie (2/2)';
                    compareButton.style.background = '#4CAF50';
                }
            }
            
            // Dodaj wizualną indykację do wybranych zdjęć w galerii
            const galleryPhotos = document.querySelectorAll('.gallery-photo');
            galleryPhotos.forEach(photoElement => {
                const img = photoElement.querySelector('img');
                if (img) {
                    const isSelected = selectedPhotosForComparison.some(p => {
                        const photoUrl = p.photo_url || p.image || p.url;
                        return img.src === photoUrl;
                    });
                    
                    if (isSelected) {
                        photoElement.style.border = '3px solid #4CAF50';
                        photoElement.style.boxShadow = '0 0 10px rgba(76, 175, 80, 0.5)';
                        // Dodaj znaczek wyboru
                        if (!photoElement.querySelector('.selection-badge')) {
                            const badge = document.createElement('div');
                            badge.className = 'selection-badge';
                            badge.style.cssText = `
                                position: absolute;
                                top: 5px;
                                right: 5px;
                                background: #4CAF50;
                                color: white;
                                border-radius: 50%;
                                width: 25px;
                                height: 25px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 12px;
                                font-weight: bold;
                                z-index: 10;
                            `;
                            const index = selectedPhotosForComparison.findIndex(p => {
                                const photoUrl = p.photo_url || p.image || p.url;
                                return img.src === photoUrl;
                            });
                            badge.textContent = index + 1;
                            photoElement.style.position = 'relative';
                            photoElement.appendChild(badge);
                        }
                    } else {
                        photoElement.style.border = '';
                        photoElement.style.boxShadow = '';
                        const badge = photoElement.querySelector('.selection-badge');
                        if (badge) badge.remove();
                    }
                }
            });
            
            // Dodaj panel z wybranymi zdjęciami jeśli są jakieś wybrane
            updateComparisonPanel();
        }
        
        // Zaktualizuj panel z wybranymi zdjęciami
        function updateComparisonPanel() {
            // Usuń istniejący panel
            const existingPanel = document.querySelector('.comparison-panel');
            if (existingPanel) existingPanel.remove();
            
            // Aktualizuj panel w pełnej galerii
            const fullscreenComparisonPanel = document.getElementById('fullscreenComparisonPanel');
            const fullscreenComparisonCount = document.getElementById('fullscreenComparisonCount');
            const fullscreenSelectedPhotos = document.getElementById('fullscreenSelectedPhotos');
            
            if (fullscreenComparisonPanel) {
                fullscreenComparisonPanel.style.display = selectedPhotosForComparison.length > 0 ? 'block' : 'none';
            }
            
            if (fullscreenComparisonCount) {
                fullscreenComparisonCount.textContent = selectedPhotosForComparison.length;
            }
            
            if (fullscreenSelectedPhotos) {
                fullscreenSelectedPhotos.innerHTML = '';
                selectedPhotosForComparison.forEach((photo, index) => {
                    const photoElement = document.createElement('div');
                    photoElement.style.cssText = `
                        position: relative;
                        width: 50px;
                        height: 50px;
                        border-radius: 4px;
                        overflow: hidden;
                        border: 2px solid #2196F3;
                    `;
                    
                    const imageUrl = photo.photo_url || photo.image || photo.url || '';
                    photoElement.innerHTML = `
                        <img src="${imageUrl}" style="
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                        ">
                        <div style="
                            position: absolute;
                            top: 0;
                            right: 0;
                            background: #2196F3;
                            color: white;
                            width: 16px;
                            height: 16px;
                            font-size: 10px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                        ">${index + 1}</div>
                    `;
                    
                    fullscreenSelectedPhotos.appendChild(photoElement);
                });
                
                // Aktualizuj przyciski akcji
                const fullscreenComparisonActions = document.getElementById('fullscreenComparisonActions');
                if (fullscreenComparisonActions) {
                    fullscreenComparisonActions.innerHTML = '';
                    
                    if (selectedPhotosForComparison.length === 2) {
                        const compareButton = document.createElement('button');
                        compareButton.textContent = 'Porównaj';
                        compareButton.style.cssText = `
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 11px;
                            font-weight: bold;
                        `;
                        compareButton.onclick = startPhotoComparison;
                        fullscreenComparisonActions.appendChild(compareButton);
                    }
                }
            }
            
            if (selectedPhotosForComparison.length === 0) return;
            
            const panel = document.createElement('div');
            panel.className = 'comparison-panel';
            panel.style.cssText = `
                position: fixed;
                top: 20px;
                left: 20px;
                background: white;
                border: 2px solid #4CAF50;
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 1000;
                max-width: 300px;
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="margin: 0; color: #333;">
                        <i class="fas fa-balance-scale"></i> Porównanie (${selectedPhotosForComparison.length}/2)
                    </h4>
                    <button onclick="clearComparison()" style="background: none; border: none; color: #666; cursor: pointer; font-size: 16px; padding: 0;">×</button>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    ${selectedPhotosForComparison.map((photo, index) => `
                        <div style="text-align: center;">
                            <img src="${photo.photo_url || photo.image || photo.url}" 
                                 style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 2px solid #4CAF50;">
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">${index + 1}</div>
                        </div>
                    `).join('')}
                    ${selectedPhotosForComparison.length === 1 ? 
                        '<div style="width: 60px; height: 60px; border: 2px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 24px;">?</div>' : ''
                    }
                </div>
                <div style="display: flex; gap: 5px;">
                    ${selectedPhotosForComparison.length === 2 ? 
                        '<button onclick="startPhotoComparison()" style="flex: 1; background: #4CAF50; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Porównaj</button>' : ''
                    }
                    <button onclick="clearComparison()" style="flex: 1; background: #f44336; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Wyczyść</button>
                </div>
            `;
            
            document.body.appendChild(panel);
        }
        
        // Dodaj zdjęcie do porównania z pełnej galerii
        function addToFullscreenComparison(photo) {
            console.log('Dodawanie do porównania z pełnej galerii:', photo);
            
            // Sprawdź czy zdjęcie już nie jest wybrane
            const isAlreadySelected = selectedPhotosForComparison.some(p => 
                (p.id || p.photo_url) === (photo.id || photo.photo_url)
            );
            
            if (isAlreadySelected) {
                // Usuń z wyboru
                selectedPhotosForComparison = selectedPhotosForComparison.filter(p => 
                    (p.id || p.photo_url) !== (photo.id || photo.photo_url)
                );
                showNotification('Zdjęcie usunięte z porównania', 'info');
            } else {
                // Dodaj do wyboru
                if (selectedPhotosForComparison.length >= 2) {
                    showNotification('Możesz wybrać maksymalnie 2 zdjęcia do porównania', 'warning');
                    return;
                }
                
                selectedPhotosForComparison.push(photo);
                showNotification(`Zdjęcie ${selectedPhotosForComparison.length}/2 wybrane do porównania`, 'success');
                
                // Jeśli wybrano 2 zdjęcia, uruchom porównanie po krótkiej chwili
                if (selectedPhotosForComparison.length === 2) {
                    setTimeout(() => {
                        startPhotoComparison();
                    }, 800);
                }
            }
            
            updateComparisonUI();
            // Odśwież pełną galerię jeśli jest otwarta
            if (document.getElementById('fullscreenGalleryOverlay').classList.contains('active')) {
                renderFullscreenGallery();
            }
        }

        // Wyczyść wybór porównania
        function clearComparison() {
            selectedPhotosForComparison = [];
            updateComparisonUI();
            // Odśwież pełną galerię jeśli jest otwarta
            if (document.getElementById('fullscreenGalleryOverlay').classList.contains('active')) {
                renderFullscreenGallery();
            }
            showNotification('Wybór porównania wyczyszczony', 'info');
        }
        
        // Pokaż zdjęcie na pełnym ekranie
        function showFullscreenPhoto() {
            const previewImage = document.getElementById('previewImage');
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.95);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                cursor: zoom-out;
            `;
            
            const img = document.createElement('img');
            img.src = previewImage.src;
            img.style.cssText = `
                max-width: 95%;
                max-height: 95%;
                object-fit: contain;
                border-radius: 8px;
            `;
            
            modal.appendChild(img);
            document.body.appendChild(modal);
            
            // Zamknij na kliknięcie
            modal.addEventListener('click', () => {
                modal.remove();
            });
            
            // Zamknij na ESC
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // Przełącz siatkę kamery - TRYB DOKUMENTACJI
        function toggleCameraGrid() {
            const video = document.getElementById('cameraPreviewDoc');
            if (!video) return;
            
            const existingGrid = video.parentElement.querySelector('.camera-grid');
            
            if (existingGrid) {
                existingGrid.remove();
            } else {
                const grid = document.createElement('div');
                grid.className = 'camera-grid';
                grid.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    pointer-events: none;
                    z-index: 5;
                `;
                
                // Dodaj linie siatki
                for (let i = 1; i <= 2; i++) {
                    const vLine = document.createElement('div');
                    vLine.style.cssText = `
                        position: absolute;
                        left: ${i * 33.33}%;
                        top: 0;
                        width: 1px;
                        height: 100%;
                        background: rgba(255,255,255,0.7);
                        box-shadow: 0 0 2px rgba(0,0,0,0.3);
                    `;
                    grid.appendChild(vLine);
                    
                    const hLine = document.createElement('div');
                    hLine.style.cssText = `
                        position: absolute;
                        top: ${i * 33.33}%;
                        left: 0;
                        width: 100%;
                        height: 1px;
                        background: rgba(255,255,255,0.7);
                        box-shadow: 0 0 2px rgba(0,0,0,0.3);
                    `;
                    grid.appendChild(hLine);
                }
                
                video.parentElement.appendChild(grid);
            }
        }
        
        // Galerię inicjalizujemy już w głównym DOMContentLoaded event listenerze
        
        // Aktualizuj galerię gdy dodane zostanie nowe zdjęcie
        function updateGallery() {
            renderGallery();
        }
        
        // Modyfikuj funkcję displayPhoto aby aktualizowała galerię
        const originalDisplayPhoto = displayPhoto;
        displayPhoto = function(photo) {
            originalDisplayPhoto(photo);
            updateGallery();
        };
        
        // ===== FUNKCJE SPRAWDZANIA JAKOŚCI =====
        
        // Funkcja sprawdzania jakości video
        function checkVideoQuality(videoElement) {
            if (!videoElement || !videoElement.videoWidth || !videoElement.videoHeight) {
                console.log('Video nie jest jeszcze gotowe do sprawdzenia jakości');
                return;
            }
            
            const actualWidth = videoElement.videoWidth;
            const actualHeight = videoElement.videoHeight;
            const aspectRatio = (actualWidth / actualHeight).toFixed(2);
            
            console.log('=== SPRAWDZENIE JAKOŚCI VIDEO ===');
            console.log(`Rzeczywista rozdzielczość: ${actualWidth} x ${actualHeight}`);
            console.log(`Proporcje: ${aspectRatio}:1`);
            
            let qualityMessage = '';
            let qualityLevel = '';
            
            if (actualWidth >= 3840 && actualHeight >= 2160) {
                qualityLevel = 'Doskonała (4K)';
                qualityMessage = `🟢 Doskonała jakość: ${actualWidth}x${actualHeight} (4K)`;
            } else if (actualWidth >= 1920 && actualHeight >= 1080) {
                qualityLevel = 'Bardzo dobra (Full HD)';
                qualityMessage = `🟡 Bardzo dobra jakość: ${actualWidth}x${actualHeight} (Full HD)`;
            } else if (actualWidth >= 1280 && actualHeight >= 720) {
                qualityLevel = 'Dobra (HD)';
                qualityMessage = `🟠 Dobra jakość: ${actualWidth}x${actualHeight} (HD)`;
            } else {
                qualityLevel = 'Podstawowa';
                qualityMessage = `🔴 Podstawowa jakość: ${actualWidth}x${actualHeight}`;
            }
            
            // Sprawdź constraints kamery
            if (currentStream) {
                const videoTrack = currentStream.getVideoTracks()[0];
                if (videoTrack) {
                    const settings = videoTrack.getSettings();
                    console.log('Ustawienia kamery:', settings);
                    
                    // Dodaj informacje o kamerze
                    if (settings.deviceId) {
                        console.log('ID urządzenia:', settings.deviceId);
                    }
                    if (settings.frameRate) {
                        console.log('Liczba klatek na sekundę:', settings.frameRate);
                    }
                }
            }
            
            // Wyświetl informację użytkownikowi
            showNotification(qualityMessage, 'info', 5000);
            
            // Dodaj wskaźnik jakości do interfejsu
            addQualityIndicator(qualityLevel, actualWidth, actualHeight);
        }
        
        // Dodaj wskaźnik jakości do interfejsu
        function addQualityIndicator(qualityLevel, width, height) {
            // Usuń poprzedni wskaźnik
            const existing = document.getElementById('quality-indicator');
            if (existing) existing.remove();
            
            const indicator = document.createElement('div');
            indicator.id = 'quality-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 8px 15px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 1000;
                font-family: Arial, sans-serif;
            `;
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-video"></i>
                    <div>
                        <div style="font-weight: bold;">${qualityLevel}</div>
                        <div style="opacity: 0.8;">${width}×${height}</div>
                    </div>
                </div>
            `;
            document.body.appendChild(indicator);
            
            // Usuń wskaźnik po 10 sekundach
            setTimeout(() => {
                if (indicator && indicator.parentNode) {
                    indicator.remove();
                }
            }, 10000);
        }
        
        // Funkcja sprawdzania jakości capture
        function checkCaptureQuality(canvas) {
            if (!canvas) return;
            
            const width = canvas.width;
            const height = canvas.height;
            
            console.log(`=== JAKOŚĆ CAPTURE ===`);
            console.log(`Rozdzielczość zdjęcia: ${width} x ${height}`);
            
            let message = '';
            if (width >= 3840 && height >= 2160) {
                message = `🟢 Zdjęcie w jakości 4K: ${width}×${height}`;
            } else if (width >= 1920 && height >= 1080) {
                message = `🟡 Zdjęcie w jakości Full HD: ${width}×${height}`;
            } else if (width >= 1280 && height >= 720) {
                message = `🟠 Zdjęcie w jakości HD: ${width}×${height}`;
            } else {
                message = `⚠️ Niska jakość zdjęcia: ${width}×${height}`;
            }
            
            showNotification(message, 'info', 3000);
        }
        
        // ===== MECHANIZM BEZPIECZEŃSTWA - USUWANIE MODALI =====
        
        // Funkcja usuwająca wszystkie modalne okna
        function clearAllModals() {
            // Usuń wszystkie modalne okna z wysokim z-index, ale zachowaj modalne okna porównywania
            const modals = document.querySelectorAll('div[style*="z-index: 11000"], div[style*="z-index: 10000"]');
            modals.forEach(modal => {
                if (modal.style.position === 'fixed') {
                    // Sprawdź czy to nie jest modal porównywania
                    const isComparisonModal = modal.innerHTML.includes('Porównanie zdjęć') || 
                                            modal.querySelector('h3')?.textContent?.includes('Porównanie zdjęć');
                    
                    if (!isComparisonModal) {
                        modal.remove();
                        console.log('Usunięto modal:', modal);
                    } else {
                        console.log('Zachowano modal porównywania:', modal);
                    }
                }
            });
            
            // Przywróć scroll body tylko jeśli nie ma aktywnych modali porównywania
            const activeComparisonModals = document.querySelectorAll('div[style*="z-index: 10000"]');
            let hasActiveComparison = false;
            
            activeComparisonModals.forEach(modal => {
                if (modal.innerHTML.includes('Porównanie zdjęć') || 
                    modal.querySelector('h3')?.textContent?.includes('Porównanie zdjęć')) {
                    hasActiveComparison = true;
                }
            });
            
            if (!hasActiveComparison) {
                document.body.style.overflow = 'auto';
            }
        }
        
        // Wyczyść modalne okna na start
        window.addEventListener('load', clearAllModals);
        
        // Wyczyść modalne okna co 5 sekund jako backup
        // setInterval(clearAllModals, 5000); // WYŁĄCZONE - użytkownik nie chce automatycznego odświeżania
        
        // Wyczyść modalne okna na klawisz ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                clearAllModals();
            }
        });
        
        // ===== PEŁNOEKRANOWA GALERIA =====
        
        // Otwórz pełnoekranową galerię
        function openFullscreenGallery() {
            const overlay = document.getElementById('fullscreenGalleryOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Inicjalizuj kontrolki pełnoekranowej galerii
            initializeFullscreenGalleryControls();
            
            // Renderuj zdjęcia
            renderFullscreenGallery();
        }
        
        // Zamknij pełnoekranową galerię
        function closeFullscreenGallery() {
            const overlay = document.getElementById('fullscreenGalleryOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // Inicjalizuj kontrolki pełnoekranowej galerii
        function initializeFullscreenGalleryControls() {
            const filterSelect = document.getElementById('fullscreenPhotoFilter');
            const sortSelect = document.getElementById('fullscreenSortBy');
            
            // Event listenery dla filtrów i sortowania
            filterSelect.addEventListener('change', renderFullscreenGallery);
            sortSelect.addEventListener('change', renderFullscreenGallery);
            
            // ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && document.getElementById('fullscreenGalleryOverlay').classList.contains('active')) {
                    closeFullscreenGallery();
                }
            });
        }
        
        // Sortuj i filtruj zdjęcia
        function sortAndFilterPhotos(photos, sortValue) {
            let filteredPhotos = [...photos];
            
            // Najpierw filtruj według regionu jeśli potrzeba
            switch(sortValue) {
                case 'czolo':
                    filteredPhotos = photos.filter(photo => {
                        const region = (photo.head_region || photo.region?.name || photo.region || '').toLowerCase();
                        return region.includes('czoło') || region.includes('czolo');
                    });
                    break;
                case 'potylica':
                    filteredPhotos = photos.filter(photo => {
                        const region = (photo.head_region || photo.region?.name || photo.region || '').toLowerCase();
                        return region.includes('potylica') || region.includes('kark');
                    });
                    break;
                case 'boki':
                    filteredPhotos = photos.filter(photo => {
                        const region = (photo.head_region || photo.region?.name || photo.region || '').toLowerCase();
                        return region.includes('boki') || region.includes('bok');
                    });
                    break;
                case 'ciemie':
                    filteredPhotos = photos.filter(photo => {
                        const region = (photo.head_region || photo.region?.name || photo.region || '').toLowerCase();
                        return region.includes('ciemię') || region.includes('ciemie');
                    });
                    break;
                case 'zakola':
                    filteredPhotos = photos.filter(photo => {
                        const region = (photo.head_region || photo.region?.name || photo.region || '').toLowerCase();
                        return region.includes('zakol');
                    });
                    break;
                case 'skronie':
                    filteredPhotos = photos.filter(photo => {
                        const region = (photo.head_region || photo.region?.name || photo.region || '').toLowerCase();
                        return region.includes('skroń') || region.includes('skronie');
                    });
                    break;
            }
            
            // Następnie sortuj
            switch(sortValue) {
                case 'newest':
                    return filteredPhotos.sort((a, b) => 
                        new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp)
                    );
                case 'oldest':
                    return filteredPhotos.sort((a, b) => 
                        new Date(a.created_at || a.timestamp) - new Date(b.created_at || b.timestamp)
                    );
                case 'region':
                    return filteredPhotos.sort((a, b) => {
                        const regionA = (a.head_region || a.region?.name || a.region || '').toLowerCase();
                        const regionB = (b.head_region || b.region?.name || b.region || '').toLowerCase();
                        return regionA.localeCompare(regionB);
                    });
                case 'region-desc':
                    return filteredPhotos.sort((a, b) => {
                        const regionA = (a.head_region || a.region?.name || a.region || '').toLowerCase();
                        const regionB = (b.head_region || b.region?.name || b.region || '').toLowerCase();
                        return regionB.localeCompare(regionA);
                    });
                default:
                    // Dla filtrów regionalnych, sortuj według daty (najnowsze)
                    return filteredPhotos.sort((a, b) => 
                        new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp)
                    );
            }
        }

        // Renderuj pełnoekranową galerię
        function renderFullscreenGallery() {
            const grid = document.getElementById('fullscreenPhotoGrid');
            const filterValue = document.getElementById('fullscreenPhotoFilter').value;
            const sortValue = document.getElementById('fullscreenSortBy').value;
            
            // Połącz wszystkie zdjęcia
            let allPhotos = [...capturedPhotos, ...historicalPhotos];
            
            // Filtruj według daty
            if (filterValue !== 'all') {
                allPhotos = filterPhotosByDate(allPhotos, filterValue);
            }
            
            // Sortuj i filtruj według regionu
            allPhotos = sortAndFilterPhotos(allPhotos, sortValue);
            
            // Wyczyść siatkę
            grid.innerHTML = '';
            
            if (allPhotos.length === 0) {
                grid.innerHTML = '<div class="no-photos" style="grid-column: 1 / -1;">Brak zdjęć do wyświetlenia</div>';
                return;
            }
            
            // Renderuj zdjęcia
            allPhotos.forEach(photo => {
                const photoElement = createFullscreenPhotoElement(photo);
                grid.appendChild(photoElement);
            });
        }
        
        // Stwórz element zdjęcia dla pełnoekranowej galerii
        function createFullscreenPhotoElement(photo) {
            const div = document.createElement('div');
            div.className = 'fullscreen-photo-item';
            div.style.cssText = `
                position: relative;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                transition: transform 0.2s ease;
                cursor: pointer;
            `;
            
            const imageUrl = photo.photo_url || photo.image || photo.url || '';
            const region = photo.head_region || photo.region?.name || photo.region || 'Nieznany region';
            const timestamp = new Date(photo.created_at || photo.timestamp).toLocaleString('pl-PL');
            const notes = photo.note || photo.notes || 'Brak notatek';
            
            // Sprawdź czy zdjęcie jest wybrane do porównania
            const isSelected = selectedPhotosForComparison.some(p => 
                (p.id || p.photo_url) === (photo.id || photo.photo_url)
            );
            
            div.innerHTML = `
                <img src="${imageUrl}" alt="Zdjęcie trychoskopowe" 
                     style="width: 100%; height: 200px; object-fit: cover;"
                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik03MCA4MEw5MCA2MEwxMzAgMTAwSDE1MFY1MEg1MFYxNTBINzBWODBaIiBmaWxsPSIjREREREREIi8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTcwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5OTk5IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiPkJyYWsgemRqxJljaWE8L3RleHQ+Cjwvc3ZnPgo='">
                
                <!-- Znaczek wyboru -->
                ${isSelected ? `
                    <div style="
                        position: absolute;
                        top: 8px;
                        right: 8px;
                        background: #4CAF50;
                        color: white;
                        border-radius: 50%;
                        width: 25px;
                        height: 25px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 12px;
                        font-weight: bold;
                        z-index: 10;
                    ">${selectedPhotosForComparison.findIndex(p => (p.id || p.photo_url) === (photo.id || photo.photo_url)) + 1}</div>
                ` : ''}
                
                <!-- Metadane -->
                <div style="
                    padding: 12px;
                    border-top: 1px solid #eee;
                ">
                    <div style="
                        font-weight: 600;
                        color: #2c3e50;
                        margin-bottom: 4px;
                        font-size: 13px;
                    ">${region}</div>
                    <div style="
                        font-size: 11px;
                        color: #666;
                        margin-bottom: 8px;
                    ">${timestamp}</div>
                    
                    <!-- Przyciski akcji -->
                    <div style="
                        display: flex;
                        gap: 4px;
                        justify-content: space-between;
                    ">
                        <button onclick="event.stopPropagation(); addToFullscreenComparison(${JSON.stringify(photo).replace(/"/g, '&quot;')})" 
                                style="
                                    flex: 1;
                                    background: ${isSelected ? '#4CAF50' : '#2196F3'};
                                    color: white;
                                    border: none;
                                    padding: 6px 8px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 10px;
                                ">
                            ${isSelected ? '✓ Wybrane' : 'Porównaj'}
                        </button>
                        <button onclick="event.stopPropagation(); showFullscreenPhotoModal(${JSON.stringify(photo).replace(/"/g, '&quot;')})" 
                                style="
                                    flex: 1;
                                    background: #666;
                                    color: white;
                                    border: none;
                                    padding: 6px 8px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                    font-size: 10px;
                                ">
                            Podgląd
                        </button>
                    </div>
                </div>
            `;
            
            // Dodaj event listener do kliknięcia na zdjęcie
            const img = div.querySelector('img');
            img.addEventListener('click', (e) => {
                e.stopPropagation();
                showFullscreenPhotoModal(photo);
            });
            
            // Dodaj efekt hover
            div.addEventListener('mouseenter', () => {
                div.style.transform = 'translateY(-2px)';
                div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            });
            
            div.addEventListener('mouseleave', () => {
                div.style.transform = 'translateY(0)';
                div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            });
            
            return div;
        }
        
        // Pokaż zdjęcie w modalnym oknie z edytorem
        function showFullscreenPhotoModal(photo) {
            console.log('=== SHOW FULLSCREEN PHOTO MODAL ===');
            console.log('Photo data:', photo);
            console.log('PhotoEditor available:', !!window.PhotoEditor);
            console.log('PhotoEditor constructor:', window.PhotoEditor);
            
            // Usuń istniejące modalne okna
            const existingModals = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10000"]');
            existingModals.forEach(modal => modal.remove());
            
            // Utworz nowe modalne okno z edytorem zdjęć
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const imageUrl = photo.photo_url || photo.image || photo.url || '';
            const region = photo.head_region || photo.region?.name || photo.region || 'Nieznany region';
            const timestamp = new Date(photo.created_at || photo.timestamp).toLocaleString('pl-PL');
            const notes = photo.note || photo.notes || 'Brak notatek';
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    max-width: 95vw;
                    max-height: 95vh;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                ">
                    <!-- Header -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px 20px;
                        border-bottom: 1px solid #e1e8ed;
                        background: #f8f9fa;
                    ">
                        <div>
                            <h3 style="margin: 0; color: #2c3e50; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-search-plus"></i>
                                Podgląd zdjęcia z edytorem
                            </h3>
                            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                                ${region} • ${timestamp}
                            </p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <!-- Przycisk pełnego ekranu dla pojedynczego zdjęcia -->
                            <button onclick="openSinglePhotoFullscreen('${imageUrl}', '${region}', '${timestamp}', '${notes}')" 
                                    style="
                                        background: #4CAF50;
                                        color: white;
                                        border: none;
                                        padding: 8px 15px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 12px;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    ">
                                <i class="fas fa-expand"></i>
                                Pełny ekran
                            </button>
                            <button onclick="closePhotoEditorModal()" 
                                    style="
                                        background: #dc3545;
                                        color: white;
                                        border: none;
                                        padding: 8px 12px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 16px;
                                    ">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div style="
                        flex: 1;
                        display: flex;
                        overflow: hidden;
                        min-height: 70vh;
                    ">
                        <!-- Edytor zdjęć (główny obszar) -->
                        <div style="
                            flex: 1;
                            background: #2c3e50;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: relative;
                        ">
                            <div id="photoEditorContainer" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                                <!-- PhotoEditor zostanie zainicjalizowany tutaj -->
                            </div>
                        </div>
                        
                        <!-- Panel informacji -->
                        <div style="
                            width: 300px;
                            background: #f8f9fa;
                            border-left: 1px solid #e1e8ed;
                            display: flex;
                            flex-direction: column;
                        ">
                            <div style="padding: 20px; flex: 1;">
                                <h4 style="margin: 0 0 15px 0; color: #2c3e50;">
                                    <i class="fas fa-info-circle"></i>
                                    Informacje o zdjęciu
                                </h4>
                                
                                <div style="margin-bottom: 15px;">
                                    <strong>Region:</strong><br>
                                    ${region}
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <strong>Data:</strong><br>
                                    ${timestamp}
                                </div>
                                
                                ${notes ? `
                                <div style="margin-bottom: 15px;">
                                    <strong>Notatki:</strong><br>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-style: italic; color: #666;">
                                        ${notes}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // Inicjalizuj PhotoEditor
            setTimeout(() => {
                console.log('=== INICJALIZACJA PHOTO EDITOR ===');
                const container = document.getElementById('photoEditorContainer');
                console.log('Container:', container);
                console.log('PhotoEditor available:', !!window.PhotoEditor);
                console.log('initPhotoEditor available:', !!window.initPhotoEditor);
                console.log('Image URL:', imageUrl);
                
                if (container && window.initPhotoEditor) {
                    try {
                        window.initPhotoEditor(imageUrl, container).then((editor) => {
                            console.log('PhotoEditor zainicjalizowany pomyślnie:', editor);
                        }).catch((error) => {
                            console.error('Błąd inicjalizacji PhotoEditor:', error);
                            // Fallback - pokaż zwykły obraz
                            container.innerHTML = `
                                <img src="${imageUrl}" alt="Zdjęcie trychoskopowe" 
                                     style="max-width: 100%; max-height: 100%; object-fit: contain;">
                            `;
                        });
                    } catch (error) {
                        console.error('Błąd inicjalizacji PhotoEditor:', error);
                        // Fallback - pokaż zwykły obraz
                        container.innerHTML = `
                            <img src="${imageUrl}" alt="Zdjęcie trychoskopowe" 
                                 style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        `;
                    }
                } else {
                    console.error('PhotoEditor niedostępny, pokazuję zwykły obraz');
                    if (container) {
                        container.innerHTML = `
                            <img src="${imageUrl}" alt="Zdjęcie trychoskopowe" 
                                 style="max-width: 100%; max-height: 100%; object-fit: contain;">
                        `;
                    }
                }
            }, 100);
        }
        
        // Funkcja do zamykania modalu edytora zdjęć
        function closePhotoEditorModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
                document.body.style.overflow = 'auto';
            }
        }
        
        // Funkcje uploadu zdjęć
        function openUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Resetuj formularz
            document.getElementById('uploadPhotoType').value = 'trichoscopy';
            document.getElementById('uploadRegionSelect').value = '';
            document.getElementById('uploadNote').value = '';
            document.getElementById('uploadPhotoFile').value = '';
            document.getElementById('uploadPreview').style.display = 'none';
            document.getElementById('uploadPhotoBtn').disabled = true;
            
            // Pokaż wybór regionu domyślnie
            document.getElementById('regionSelectContainer').style.display = 'block';
            
            // Dodaj event listener do pliku
            document.getElementById('uploadPhotoFile').addEventListener('change', handleFileSelect);
            
            // Dodaj event listener do typu zdjęcia
            document.getElementById('uploadPhotoType').addEventListener('change', handlePhotoTypeChange);
        }
        
        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('uploadPreview');
            const previewImg = document.getElementById('uploadPreviewImg');
            const uploadBtn = document.getElementById('uploadPhotoBtn');
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    uploadBtn.disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                uploadBtn.disabled = true;
                alert('Proszę wybrać plik obrazu.');
            }
        }
        
        function handlePhotoTypeChange(event) {
            const photoType = event.target.value;
            const regionContainer = document.getElementById('regionSelectContainer');
            
            if (photoType === 'clinical') {
                regionContainer.style.display = 'none';
            } else {
                regionContainer.style.display = 'block';
            }
        }
        
        async function uploadPhoto() {
            const photoType = document.getElementById('uploadPhotoType').value;
            const region = document.getElementById('uploadRegionSelect').value;
            const note = document.getElementById('uploadNote').value;
            const file = document.getElementById('uploadPhotoFile').files[0];
            
            // Sprawdź region tylko dla trychoskopii
            if (photoType === 'trichoscopy' && !region) {
                alert('Proszę wybrać region dla zdjęcia trychoskopowego.');
                return;
            }
            
            if (!file) {
                alert('Proszę wybrać zdjęcie.');
                return;
            }
            
            try {
                const pesel = window.location.pathname.split('/').pop();
                const formData = new FormData();
                formData.append('photo', file);
                formData.append('note', note);
                
                // Dodaj odpowiednie pola w zależności od typu
                if (photoType === 'trichoscopy') {
                    formData.append('head_region', region);
                } else {
                    formData.append('photo_type', 'clinical');
                }
                
                // Wybierz odpowiedni endpoint
                let endpoint;
                if (photoType === 'clinical') {
                    endpoint = `/api/save-clinical-photo/${pesel}`;
                } else {
                    endpoint = `/api/save-trichoscopy-photo/${pesel}`;
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const message = photoType === 'clinical' ? 'Obraz kliniczny został dodany pomyślnie!' : 'Zdjęcie zostało dodane pomyślnie!';
                    showNotification(message, 'success');
                    closeUploadModal();
                    
                    // Odśwież galerię
                    await loadHistoricalPhotos();
                    renderFullscreenGallery();
                } else {
                    alert('Błąd podczas dodawania zdjęcia: ' + result.error);
                }
            } catch (error) {
                console.error('Błąd uploadu:', error);
                alert('Błąd podczas dodawania zdjęcia.');
            }
        }
        
        // Nowa funkcja dla pełnego ekranu pojedynczego zdjęcia
        function openSinglePhotoFullscreen(imageUrl, region, timestamp, notes) {
            const fullscreenModal = document.createElement('div');
            fullscreenModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: black;
                z-index: 11000;
                display: flex;
                flex-direction: column;
            `;
            
            fullscreenModal.innerHTML = `
                <!-- Header minimalistyczny -->
                <div style="
                    position: absolute;
                    top: 20px;
                    left: 20px;
                    right: 20px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background: rgba(0,0,0,0.7);
                    padding: 10px 20px;
                    border-radius: 8px;
                    color: white;
                    z-index: 11001;
                ">
                    <div>
                        <strong>${region}</strong> • ${timestamp}
                        ${notes ? `<br><small style="opacity: 0.8;">${notes}</small>` : ''}
                    </div>
                    <button onclick="this.closest('div[style*=\"z-index: 11000\"]').remove()" 
                            style="
                                background: rgba(220, 53, 69, 0.8);
                                color: white;
                                border: none;
                                padding: 10px 15px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 16px;
                            ">
                        <i class="fas fa-times"></i> Zamknij
                    </button>
                </div>
                
                <!-- Zdjęcie na pełnym ekranie -->
                <div style="
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 80px 20px 20px 20px;
                ">
                    <img src="${imageUrl}" 
                         style="
                             max-width: 100%;
                             max-height: 100%;
                             object-fit: contain;
                             border-radius: 8px;
                         "
                         onclick="event.stopPropagation();">
                </div>
            `;
            
            // Zamknij na ESC
            const closeOnEsc = (e) => {
                if (e.key === 'Escape') {
                    fullscreenModal.remove();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            };
            document.addEventListener('keydown', closeOnEsc);
            
            // Zamknij na kliknięcie w tło
            fullscreenModal.addEventListener('click', (e) => {
                if (e.target === fullscreenModal) {
                    fullscreenModal.remove();
                    document.removeEventListener('keydown', closeOnEsc);
                }
            });
            
            document.body.appendChild(fullscreenModal);
        }
    </script>
</body>
</html> 